# DevOps

![DevOps](https://docs.docker.com/get-started/images/laurel-docker-containers.png)

### Docker Engine

![Docker Engine](https://docs.docker.com/engine/images/engine-components-flow.png)

### Docker architecture

![Docker architecture](https://docs.docker.com/engine/images/architecture.svg)

### Docker èƒ½å¹²ä»€ä¹ˆï¼Ÿ

* ç®€åŒ–é…ç½®
* ä»£ç æµæ°´çº¿ç®¡ç†
* æé«˜å¼€å‘æ•ˆç‡
* éš”ç¦»åº”ç”¨
* æ•´åˆæœåŠ¡å™¨
* è°ƒè¯•èƒ½åŠ›
* å¤šç§Ÿæˆ·
* å¿«é€Ÿéƒ¨ç½²

### å®¹å™¨æ—¶ä»£
* docker & kubernetes(k8s)

### DevOps = æ–‡åŒ– + è¿‡ç¨‹ + å·¥å…·

![devops](./images/devops.png)

### "çŸ³å™¨æ—¶ä»£"

* éƒ¨ç½²éå¸¸æ…¢
* æˆæœ¬éå¸¸é«˜
* èµ„æºæµªè´¹
* éš¾äºè¿ç§»å’Œæ‰©å±•
* å¯èƒ½ä¼šè¢«é™å®šç¡¬ä»¶å‚å•†

### è™šæ‹ŸåŒ–æŠ€æœ¯å‡ºç°ä»¥å

* ä¸€ä¸ªç‰©ç†æœºå¯ä»¥éƒ¨ç½²å¤šä¸ªapp
* æ¯ä¸ªappç‹¬ç«‹è¿è¡Œåœ¨ä¸€ä¸ªVMé‡Œ

### è™šæ‹ŸåŒ–çš„ä¼˜ç‚¹

* èµ„æºæ±  - ä¸€ä¸ªç‰©ç†æœºçš„èµ„æºåˆ†é…åˆ°ä¸åŒçš„è™šæ‹Ÿæœºé‡Œé¢
* å¾ˆå®¹æ˜“æ‰©å±• - åŠ ç‰©ç†æœº Or åŠ è™šæ‹Ÿæœº
* å¾ˆå®¹æ˜“äº‘åŒ– - äºšé©¬é€ŠAWS,é˜¿é‡Œäº‘ 

### è™šæ‹ŸåŒ–çš„å±€é™æ€§

* æ¯ä¸€ä¸ªè™šæ‹Ÿæœºéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œè¦ç»™å…¶åˆ†é…èµ„æºï¼Œ
å½“è™šæ‹Ÿæœºèµ„æºå¢å¤šæ—¶ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«æ¶ˆè€—çš„èµ„æºåŠ¿å¿…å¢å¤š

### å®¹å™¨è§£å†³äº†ä»€ä¹ˆé—®é¢˜

* è§£å†³äº†å¼€å‘ä¸è¿ç»´ä¹‹é—´çš„çŸ›ç›¾
* åœ¨å¼€å‘ä¸è¿ç»´ä¹‹é—´æ­å»ºäº†ä¸€ä¸ªæ¡¥æ¢ï¼Œæ˜¯å®ç° devops çš„æœ€ä½³
è§£å†³æ–¹æ¡ˆ

### ä»€ä¹ˆæ˜¯å®¹å™¨

* å¯¹è½¯ä»¶å’Œå…¶ä¾èµ–çš„æ ‡å‡†åŒ–æ‰“åŒ…
* åº”ç”¨ä¹‹é—´ç›¸äº’éš”ç¦»
* å…±äº«åŒä¸€ä¸ªOS kernel
* å¯ä»¥è¿è¡Œåœ¨å¾ˆå¤šä¸»æµæ“ä½œç³»ç»Ÿä¹‹ä¸Š

### å®¹å™¨å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«

* å®¹å™¨æ˜¯Appå±‚é¢çš„éš”ç¦»
* è™šæ‹ŸåŒ–æ˜¯ç‰©ç†èµ„æºå±‚é¢çš„éš”ç¦»

<img alt="Containers" src="https://docs.docker.com/images/Container%402x.png" width="300" height="300">&nbsp;&nbsp;&nbsp;<img alt="virtual machines" src="https://docs.docker.com/images/VM%402x.png" width="300" height="300">

### è™šæ‹ŸåŒ– + å®¹å™¨

### Docker 

å®¹å™¨æŠ€æœ¯çš„ä¸€ç§å®ç°

### Mac ä¸Š Docker å®‰è£…

[Install Docker Desktop for Mac](https://docs.docker.com/docker-for-mac/install/)

**What the install includes: The installation provides Docker Engine, Docker CLI client, Docker Compose, Docker Machine, and Kitematic.**

```sh
docker --version
docker version
```

### Vagrant + VirtualBoxæ­å»ºå®éªŒç¯å¢ƒ
**Development Environments Made Easy**

å…ˆå®‰è£… [VirtualBox](https://www.virtualbox.org/wiki/Downloads)

æ¥ä¸‹çœ‹ Vagrant å…¥é—¨æŒ‡å—->[Getting Started](https://www.vagrantup.com/intro/getting-started/index.html)

[Vagrant Cloud](https://app.vagrantup.com/boxes/search)
* [centos/7 Vagrant box](https://app.vagrantup.com/centos/boxes/7)

```sh
vagrant --help

vagrant init centos/7 # åˆ›å»ºäº†ä¸€ä¸ª Vagrantfile

more Vagrantfile # æè¿°äº†æˆ‘ä»¬è¦åˆ›å»ºçš„è™šæœº

vagrant up # å»æ‰¾ base box(local or cloud)
vagrant ssh # è¿›å…¥è™šæœº
sudo yum update # æ›´æ–°è™šæœº
exit # é€€å‡ºè™šæœº

vagrant status # æŸ¥çœ‹è™šæœºçŠ¶æ€
vagrant halt # åœæ‰è™šæœº

vagrant status # poweroff

vagrant destroy # åˆ æ‰è™šæœº
```

åˆ›å»ºä¸€å°è™šæœºåªéœ€ä¸€ä¸ª `Vagrantfile` æ–‡ä»¶å³å¯

å¯ä»¥ google æœç´¢ Vagrantfile å¦‚ï¼š`Vagrantfile CentOS`

åˆ›å»ºä¸€å°è™šæœºåªéœ€ä¸€ä¸ª `Vagrantfile` æ–‡ä»¶å³å¯

[CentOS ä¸­å®‰è£… Docker, ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/install/linux/docker-ce/centos/) 

```sh
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

sudo yum install -y yum-utils device-mapper-persistent-data lvm2

sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

sudo yum install docker-ce

sudo systemctl start docker

sudo docker version # æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯

sudo docker run hello-world # éªŒè¯ä¸€ä¸‹
```

åœ¨ Vagrantfile ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å¯ä»¥é…ç½®æœºå™¨å¯åŠ¨æ—¶è‡ªåŠ¨å®‰è£…å¥½Docker

```sh
config.vm.provision "shell", inline: <<-SHELL
  sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
  sudo yum install -y yum-utils device-mapper-persistent-data lvm2
  sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  sudo yum install docker-ce
  sudo systemctl start docker
SHELL
```

ç½‘ç»œä¸‹è½½å¤ªæ…¢ï¼Œé€šè¿‡ `vagrant up` æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿åˆ° box çš„ä¸‹è½½åœ°å€ï¼Œç„¶åè¿…é›·ä¸‹è½½

ç¦»çº¿å®‰è£… centos7 box

```sh
cd ~/Vagrant/CentOS7 # æ‰¾åˆ°ä¸€ä¸ªç›®å½•ï¼Œä½œä¸ºåˆå§‹åŒ–ç›®å½•
vagrant box add centos/7 ~/Downloads/virtualbox.box # å»ºè®®é‡‡å–ç¦»çº¿å®‰è£…ï¼Œè¿™æ ·æœ‰åˆ©äºæ”¾ç½®è™šæ‹Ÿæœºæ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„
vagrant init centos/7 # åˆå§‹åŒ– Vagrantfile
vagrant up #å¯åŠ¨
vagrant ssh #è¿›å…¥VM
exit #é€€å‡º
vagrant status #æŸ¥çœ‹çŠ¶æ€
vagrant halt #åœæ‰
vagrant status #æŸ¥çœ‹çŠ¶æ€
vagrant destroy #åˆ æ‰æœºå™¨
```

æŸ¥çœ‹boxes

```sh
cd ~/.vagrant.d/boxes
```
### Docker Machine

[Docker Machine Overview](https://docs.docker.com/machine/overview/)

mac é»˜è®¤å°±å·²ç»å®‰è£…å¥½äº†

```sh
docker-machine version
```

Docker Machine èƒ½å¹²ä»€ä¹ˆï¼Ÿ(å¦‚ï¼šæœ¬åœ°å¿«é€Ÿåœ¨ VirtualBox ç¯å¢ƒä¸­åˆ›å»ºä¸€å°å…·æœ‰ Docker ç¯å¢ƒçš„æœºå™¨)

```sh
docker-machine --help # ä¹ æƒ¯çœ‹å¸®åŠ©

docker-machine create demo # æˆ‘æœ¬åœ°æ˜¯ç›´æ¥åœ¨ VirtualBox åˆ›å»ºä¸€ä¸ªå·²ç»å®‰è£…å¥½äº†çš„è™šæ‹Ÿæœº

docker-machine ls # çœ‹çœ‹å·²ç»å®‰è£…å¥½äº†çš„æœºå™¨
docker-machine ssh demo # è¿›å…¥åˆ°æœºå™¨é‡Œé¢
docker version
exit # é€€å‡º

docker-machine help # æŸ¥çœ‹å¸®åŠ©å‘½ä»¤

docker-machine create demo1 # å†åˆ›å»ºä¸€å°
docker-machine ls # çœ‹ä¸€ä¸‹
docker-machine stop demo1 # åœæ‰ demo1
docker-machine ls # å†çœ‹ä¸€ä¸‹è¾“å‡º
docker-machine stop demo # åœæ‰ demo
```

### åšä¸ªè¯•éªŒï¼Œè¿œç¨‹ç®¡ç†ä½ çš„ docker machine

å…ˆé€€å‡ºæœ¬åœ° mac å¯åŠ¨ docker server

```sh
docker version #çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯è¿ä¸ä¸Š server
docker-machine start demo #å¯åŠ¨ä¸‹ demo
docker-machine env demo #æš´éœ²å‡ºç¯å¢ƒå˜é‡

eval $(docker-machine env demo)
docker version #å‘ç°è¿ä¸Šäº†ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¿œç¨‹ç®¡ç† docker machine, æœ¬åœ°åªè¦ä¸€ä¸ª client å°±å¥½äº†
```

è¯¦ç»†æ–‡æ¡£ [Provision hosts in the cloud](https://docs.docker.com/machine/get-started-cloud/)

### é˜¿é‡Œäº‘ä¸Šåˆ›å»ºä¸€å° Docker Machine

[Drivers for cloud providers](https://docs.docker.com/machine/drivers/)

[3rd-party driver plugins](https://github.com/docker/docker.github.io/blob/master/machine/AVAILABLE_DRIVER_PLUGINS.md)

ä»“åº“åœ°å€ï¼š[Docker Machine Driver of Aliyun ECS](https://github.com/AliyunContainerService/docker-machine-driver-aliyunecs)

`README.md` æœ‰å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ŒğŸ‘‡ç®€çŸ­è¯´ä¸€ä¸‹ï¼š

ä¸‹è½½å¯¹åº”çš„ Driver, Mac OSX 64 bit: [docker-machine-driver-aliyunecs_darwin-amd64](https://docker-machine-aliyunecs-drivers.oss-cn-beijing.aliyuncs.com/docker-machine-driver-aliyunecs_darwin-amd64.tgz)

é‡å‘½å binary æ¡£ä¸º `docker-machine-driver-aliyunecs`ï¼Œç„¶åç§»åŠ¨åˆ° `/usr/local/bin`

éªŒè¯ä¸€ä¸‹ï¼ŒDriver æ˜¯å¦å®‰è£…æˆåŠŸ
```sh
docker-machine create -d aliyunecs --help
```

è¿›å…¥é˜¿é‡Œäº‘åå°ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥ `accesskeys` è¿›è¡Œåˆ›å»ºç”¨æˆ· AccessKey ID

å¥½çš„æ–¹å¼è¿˜æ˜¯ç›´æ¥æ ¹æ®æç¤ºæŒ‰ç…§ `ä½¿ç”¨å­ç”¨æˆ· AccessKey` æ–¹å¼åˆ›å»º

![aliyun-access-key](./images/aliyun-accesskey.png)

**æ³¨æ„ï¼šè¦åœ¨æ§åˆ¶å°æ·»åŠ å¥½å­è´¦å·æƒé™å’Œå……å€¼100+**

```sh
docker-machine create -d aliyunecs --aliyunecs-io-optimized=optimized --aliyunecs-access-key-id=<your key> --aliyunecs-access-key-secret=<your secret> --aliyunecs-region=cn-qingdao devops

docker-machine ssh devops # è¿›å…¥ shell
docker-machine env devops
eval $(docker-machine env devops)
docker version # çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰è¿ä¸Šè¿œç«¯çš„ server

docker-machine env --help # æŸ¥çœ‹ä¸‹å¸®åŠ©
docker-machine env --unset # å»æ‰åˆšè®¾çš„ç¯å¢ƒå˜é‡
eval $(docker-machine env --unset) 

docker version
```

**åº”ç”¨ï¼š**ï¼Œç¬é—´åˆ› 20 å°æœºå™¨å»åš`å•¦å•¦å•¦ğŸ˜‹ğŸ˜â€¦â€¦` ï¼Œåšå®Œç„¶åé”€æ¯ğŸ¤£

### Online Docker Playground

[Play with Docker](https://labs.play-with-docker.com/)

![Play with Docker](./images/play-with-docker.png)

### Docker æ¶æ„å’Œåº•å±‚æŠ€æœ¯

Docker Platform

* Docker æä¾›äº†ä¸€ä¸ªå¼€å‘ï¼Œæ‰“åŒ…ï¼Œè¿è¡Œ app çš„å¹³å°
* æŠŠ app å’Œåº•å±‚ infrastructure éš”ç¦»å¼€æ¥

Docker Engine

* åå°è¿›ç¨‹(dockerd)
* REST API Server
* CLI æ¥å£(docker)

```sh
vagrant ssh
sudo docker version
ps -ef | grep docker # çœ‹åˆ°æœ‰dockerdçš„è¿›ç¨‹
```

Docker Architecture

Client
* docker build
* docker pull
* docker run

DOCKER_HOST
* Docker daemon
* Containers
* Images

Registry
* Ubuntu
* Redis
* Niginx
* ...images

åº•å±‚æŠ€æœ¯çš„æ”¯æŒ
* Namespacesï¼šåšéš”ç¦» pid, net, ipc, mnt, uts
* Control groups: åšèµ„æºé™åˆ¶
* Union file systems: Container å’Œ Image åˆ†å±‚

### ä»€ä¹ˆæ˜¯ Image

* æ–‡ä»¶å’Œ meta data çš„é›†åˆ(root filesystem)
* åˆ†å±‚çš„ï¼Œå¹¶ä¸”æ¯ä¸€å±‚éƒ½å¯ä»¥æ·»åŠ æ”¹å˜ï¼Œåˆ é™¤æ–‡ä»¶ï¼Œæˆä¸ºä¸€ä¸ªæ–°çš„ image
* ä¸åŒçš„ image å¯ä»¥å…±äº«ç›¸åŒçš„ layer
* Image æœ¬èº«æ˜¯ read-only çš„

```sh
vagrant ssh
sudo docker image ls #åˆ—ä¸¾å‡ºæœ¬åœ°æœ‰çš„image
```

Image çš„è·å–

* Build from Dockerfile
* Pull from Registry
  ```sh
  sudo docker image ls
  sudo docker pull ubuntu:14.04
  sudo docker image ls
  ```
### Docker Hub

[Docker Hub Quickstart](https://docs.docker.com/docker-hub/)

[hub.docker.com](https://hub.docker.com/)

### Base Image

åœ¨Vagrantä¸­ï¼Œè§£å†³å½“å‰ç”¨æˆ· `docker` å‰è¦åŠ  `sudo` çš„é—®é¢˜

```sh
sudo groupadd docker # å®è´¨ä¸Šå®‰è£…å¥½ docker åï¼Œå®ƒå·²ç»å­˜åœ¨äº†
sudo gpasswd -a vagrant docker # å°†å½“å‰ç”¨æˆ·æ·»åŠ è¿™ä¸ªgroupé‡Œé¢
sudo service docker restart # æ³¨æ„ä¹‹åè¦é‡å¯ docker è¿›ç¨‹

exit # é€€å‡º,é‡æ–°ç™»å½•
vagrant ssh
docker image ls # ç°åœ¨å°±ä¸ç”¨åŠ  sudo äº†
```

é¦–å…ˆçœ‹ä¸€çœ‹ `hello-world` è¿™ä¸ª Base Image

```sh
docker pull hello-world #  è¿™ä¹Ÿæ˜¯ä¸€ä¸ª base imageï¼Œä»…ä»…åŒ…å«ç±»ä¼¼äºä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„æ–‡ä»¶

docker image ls # å‘ç°è¿™ä¸ªImageåªæœ‰1.85kbï¼Œéå¸¸éå¸¸å°

docker run hello-world # è¿™æ ·å°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨ï¼ˆæ‰§è¡Œä¸€ä¸ªImage)
```

### åˆ¶ä½œ `Hello-Docker` Base Image

```sh
# vagrant ssh
# å®‰è£…ä¸€äº›å¿…è¦çš„åŒ…
sudo yum install git
sudo yum install vim

mkdir hello-docker
cd hello-docker/
vim hello.c
#   #include<stdio.h>
#   int main()
#   {
#      printf("hello docker\n");
#   }

:wq # ä¿å­˜é€€å‡º Vim ç¥å™¨

history | grep yum # çœ‹ä¸€ä¸‹å®‰è£…å†å²

# å®‰è£…ç¼–è¯‘å™¨å’Œé™æ€ç‰ˆæœ¬åº“
sudo yum install gcc
sudo yum install glibc-static

gcc -static hello.c -o hello # ç¼–è¯‘

ls # å‘ç°å¤šäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶`hello`
./hello # æ‰§è¡Œä¸€æ¬¡çœ‹ä¸€ä¸‹

```

ç°åœ¨ï¼Œå°±å¯ä»¥ç”¨ Dockerfile æŠŠå®ƒå¼„æˆä¸€ä¸ª Docker Image

```yaml
FROM scratch # å› ä¸ºæ˜¯base image,æ‰€ä»¥è¿™é‡Œä¸èƒ½æ˜¯å…¶å®ƒ
ADD hello / # å°†è¿™ä¸ª`hello`æ·»åŠ åˆ°æ ¹ç›®å½•
CMD ["/hello"] # æ‰§è¡Œå®ƒ
```

```sh
# æ„å»º ç„¶åæ‰“ tagï¼Œåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾Dockerfileï¼Œå› ä¸ºæœ‰ä¸‰æ­¥ï¼Œæ‰€ä»¥è¿™ä¸ªImageæœ‰ä¸‰å±‚
docker build -t kirkwwang/hello-docker .

docker image ls # çœ‹ä¸€ä¸‹,å‘ç°è¿™ä¸ªImageåªæœ‰857KB

ls -lh # çœ‹ä¸€ä¸‹`hello`è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶,åªæœ‰837KB

docker history b3a43698719c # çœ‹ä¸€ä¸‹è¿™ä¸ªimageæœ‰å‡ å±‚ï¼Œå‘ç°æ˜¯ä¸¤å±‚ï¼Œå› ä¸ºFROM scratchæœ¬èº«å°±æ²¡æœ‰FROMå…¶å®ƒImage,å¯ä»¥ä¸ç®—ä½œä¸€å±‚

docker run kirkwwang/hello-docker # è¿è¡Œçœ‹ä¸€ä¸‹ï¼Œéº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨
```

### ä»€ä¹ˆæ˜¯ Container

* é€šè¿‡ Image å»åˆ›å»º(copy)
* åœ¨ Image Layer ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ª container layer(å¯è¯»å†™)
* ç±»æ¯”é¢å‘å¯¹è±¡ï¼šç±»å’Œå®ä¾‹
* Image è´Ÿè´£ app å­˜å‚¨å’Œåˆ†å‘ï¼ŒContainer è´Ÿè´£è¿è¡Œ app

```sh
docker container ls # æŸ¥çœ‹å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨
docker container ls -a # æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨ï¼ˆæ­£åœ¨è¿è¡Œçš„ä»¥åŠé€€å‡ºçš„ï¼‰

more hello-docker/Dockerfile # çœ‹CMDé‚£ä¸€è¡Œï¼Œå½“æˆ‘ä»¬ docker run çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šå»æ‰§è¡Œ CMD é‡Œé¢çš„å‘½ä»¤

docker run centos # é»˜è®¤ä¼šç”¨latestç‰ˆæœ¬
docker container ls -a # å®ƒé»˜è®¤æ‰§è¡Œçš„æ˜¯/bin/bashï¼Œä½†ä¹Ÿä¼šé€€å‡ºï¼Œä¸æ˜¯äº¤äº’å¼è¿è¡Œï¼Œä¸å¸¸é©»å†…å­˜

docker run --help # æ³¨æ„çœ‹å¸®åŠ© -iï¼Œ-t

docker run -it centos # å‘ç°æˆ‘ä»¬è¿›å…¥åˆ°äº†å®¹å™¨é‡Œé¢
touch test.txt # å¤šäº†ä¸€ä¸ªå¯è¯»å¯å†™çš„ container layer,æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶
ls
yum install vim # å†æ‰§è¡Œä¸€æ¡å®‰è£…å‘½ä»¤
```

å¼€ä¸ªæ–°çš„terminal

```sh
cd ~/Vagrant/CentOS7
vagrant ssh
docker container ls # å‘ç°æœ‰æ­£åœ¨è¿è¡Œå®¹å™¨ centosï¼ŒCOMMAND æ˜¯ /bin/bash
```

é€€å‡ºå®¹å™¨

```sh
exit # é€€å‡ºè¿™ä¸ªå®¹å™¨
docker container ls # çœ‹ä¸åˆ°æ­£åœ¨è¿è¡Œçš„å®¹å™¨äº†
docker container ls -a
```

Docker çš„å‘½ä»¤åˆ†ä¸ºä¸¤å¤§å—ï¼šManagement Commands & Commands

Management Commands ï¼šä¸»è¦æ˜¯å¯¹Dockeré‡Œé¢çš„å…·ä½“å¯¹è±¡è¿›è¡Œç®¡ç†

```sh
docker image # çœ‹ä¸€ä¸‹imageä¸‹åˆæœ‰é‚£ä¸€äº›å‘½ä»¤
docker image ls
docker container # çœ‹ä¸€ä¸‹containerä¸‹åˆæœ‰é‚£ä¸€äº›å‘½ä»¤
docker container ls -a
docker container rm dfc145ac218f
docker container rm 3e # id æ— éœ€å†™å…¨
```

Commandsï¼šæä¾›ä¸€äº›ç®€ä¾¿æ–¹æ³•ï¼Œä¸ç”¨å‘½ä»¤å†™çš„å¤ªé•¿

```sh
docker ps #  == docker container ls
docker ps -a #  == docker container ls -a
docker rm cf # == docker container rm cf
docker images # == docker image ls
docker rmi fce289e99eb9 # docker image rm fce289e99eb9
```

å¦‚ä½•ä¸€æ¬¡æ€§æ¸…ç†æ‰æ‰€æœ‰çš„å®¹å™¨?

```sh
docker run kirkwwang/hello-docker # å…ˆåˆ›å»º5ä¸ªcontainer
docker run kirkwwang/hello-docker
docker run kirkwwang/hello-docker
docker run kirkwwang/hello-docker
docker run kirkwwang/hello-docker

docker ps -a # çœ‹ä¸€ä¸‹å…¨éƒ¨

docker container ls -aq # åˆ—ä¸¾å‡ºæ‰€æœ‰çš„id
docker container ls -a | awk {'print$1'} # æ‰“å°å‡ºç¬¬ä¸€åˆ—
docker rm $(docker container ls -aq) # å…¨éƒ¨æ¸…ç† == docker rm $(docker ps -aq)

# åªæ¸…ç†å·²ç»é€€å‡ºçš„
docker run kirkwwang/hello-docker # å…ˆ run 5 ä¸ª
docker container ls -f "status=exited" # åˆ—å‡ºé€€å‡ºçš„å®¹å™¨
docker container ls -f "status=exited" -q # åˆ—ä¸¾å‡ºæ‰€æœ‰çš„id
docker rm $(docker container ls -f "status=exited" -q) # åªæ¸…ç†å·²ç»é€€å‡ºçš„
docker rm $(docker ps -f "status=exited" -q) # åŒæ ·çš„æ•ˆæœ
```

### åŸºäºä¸€ä¸ª Container æ„å»º Image

åŸºäºæŸä¸ª Image åˆ›å»ºä¸€ä¸ª Container, ç„¶ååœ¨è¿™ä¸ª Container é‡Œé¢åšä¸€äº›å˜åŒ–ï¼Œå¦‚ï¼šå®‰è£…äº†æŸä¸ªè½¯ä»¶

æŠŠè¿™ä¸ªå·²ç»æ”¹å˜äº†çš„ Containerï¼Œ Commit æˆä¸€ä¸ªæ–°çš„ Image

```sh
# vagrant ssh
docker image ls
docker run -it centos
yum install -y vim
vim # ç„ä¸€çœ¼
exit # é€€å‡º
docker container ls -a # çœ‹åˆ°ä¸€ä¸ªé€€å‡ºçŠ¶æ€çš„ centos

docker commit # çœ‹ä¸€çœ¼è¿™ä¸ªå‘½ä»¤æ¥æ”¶å“ªäº›å‚æ•°
docker commit elastic_dewdney kirkwwang/centos-vim # elastic_dewdney ç”¨çš„NAMESï¼Œkirkwwang/centos-vim è¿™ä¸ªç”¨çš„tagé»˜è®¤æ˜¯latest

docker image ls # çœ‹ä¸€çœ¼images

# æ¯”è¾ƒä¸€ä¸‹ centos ä¸ kirkwwang/centos-vim çš„åˆ†å±‚
docker history centos
docker history kirkwwang/centos-vim # OK, å‘ç°æœ‰vimçš„å¤šäº†ä¸€å±‚ï¼Œå…¶å®ƒçš„éƒ½æ˜¯å…±äº«åŸæ¥çš„
```

**ä¸æå€¡è¿™ç§æ–¹å¼åˆ›å»º Imageã€‚å‘å¸ƒå‡ºå»ï¼Œå…¶å®å¹¶ä¸çŸ¥é“è¿™ä¸ª Image æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼ˆé¬¼çŸ¥é“ä½ é‡Œé¢å®‰è£…å•¥è½¯ä»¶[ç—…æ¯’]ï¼‰ï¼Œä¸å®‰å…¨**

### é€šè¿‡ Dockerfile å»æ„å»ºä¸€ä¸ª Image

```sh
docker image ls
docker image rm kirkwwang/centos-vim # åˆ æ‰åˆšåˆ›å»ºçš„image

mkdir docker-centos-vim
cd docker-centos-vim
vim Dockerfile
```

`Dockerfile` æ–‡ä»¶å†…å®¹

```yml
FROM centos
RUN yum install -y vim
# ä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ Container è¿è¡Œå‘½ä»¤ï¼Œç„¶åå» Commit æˆä¸€ä¸ªæ–°çš„ Image
# æœ€ååˆ æ‰é‚£ä¸ªä¸´æ—¶çš„ Container
```

```sh
docker build -t kirkwwang/centos-vim-new . # -t æ‰“ tag, `.`åŸºæœ¬äºå½“å‰ç›®å½•çš„Dockerfileæ„å»º

docker image ls # çœ‹ä¸€çœ¼æ–°ç”Ÿæˆçš„ image
```

### Dockerfile æœ€ä½³å®è·µ

[Best practices for writing Dockerfiles](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)

FROM

```yml
FROM scratch # åˆ¶ä½œ Base Image
FROM centos # ä½¿ç”¨ Base Image
FROM ubuntu:14.04
```

**ä¸ºäº†å®‰å…¨ï¼Œå°½é‡ä½¿ç”¨å®˜æ–¹çš„ Image ä½œä¸º Base Imageï¼**
