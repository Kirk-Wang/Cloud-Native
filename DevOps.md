# DevOps

![DevOps](https://docs.docker.com/get-started/images/laurel-docker-containers.png)

### Docker Engine

![Docker Engine](https://docs.docker.com/engine/images/engine-components-flow.png)

### Docker architecture

![Docker architecture](https://docs.docker.com/engine/images/architecture.svg)

### Docker èƒ½å¹²ä»€ä¹ˆï¼Ÿ

* ç®€åŒ–é…ç½®
* ä»£ç æµæ°´çº¿ç®¡ç†
* æé«˜å¼€å‘æ•ˆç‡
* éš”ç¦»åº”ç”¨
* æ•´åˆæœåŠ¡å™¨
* è°ƒè¯•èƒ½åŠ›
* å¤šç§Ÿæˆ·
* å¿«é€Ÿéƒ¨ç½²

### å®¹å™¨æ—¶ä»£
* docker & kubernetes(k8s)

### DevOps = æ–‡åŒ– + è¿‡ç¨‹ + å·¥å…·

![devops](./images/devops.png)

### "çŸ³å™¨æ—¶ä»£"

* éƒ¨ç½²éå¸¸æ…¢
* æˆæœ¬éå¸¸é«˜
* èµ„æºæµªè´¹
* éš¾äºè¿ç§»å’Œæ‰©å±•
* å¯èƒ½ä¼šè¢«é™å®šç¡¬ä»¶å‚å•†

### è™šæ‹ŸåŒ–æŠ€æœ¯å‡ºç°ä»¥å

* ä¸€ä¸ªç‰©ç†æœºå¯ä»¥éƒ¨ç½²å¤šä¸ªapp
* æ¯ä¸ªappç‹¬ç«‹è¿è¡Œåœ¨ä¸€ä¸ªVMé‡Œ

### è™šæ‹ŸåŒ–çš„ä¼˜ç‚¹

* èµ„æºæ±  - ä¸€ä¸ªç‰©ç†æœºçš„èµ„æºåˆ†é…åˆ°ä¸åŒçš„è™šæ‹Ÿæœºé‡Œé¢
* å¾ˆå®¹æ˜“æ‰©å±• - åŠ ç‰©ç†æœº Or åŠ è™šæ‹Ÿæœº
* å¾ˆå®¹æ˜“äº‘åŒ– - äºšé©¬é€ŠAWS,é˜¿é‡Œäº‘ 

### è™šæ‹ŸåŒ–çš„å±€é™æ€§

* æ¯ä¸€ä¸ªè™šæ‹Ÿæœºéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œè¦ç»™å…¶åˆ†é…èµ„æºï¼Œ
å½“è™šæ‹Ÿæœºèµ„æºå¢å¤šæ—¶ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«æ¶ˆè€—çš„èµ„æºåŠ¿å¿…å¢å¤š

### å®¹å™¨è§£å†³äº†ä»€ä¹ˆé—®é¢˜

* è§£å†³äº†å¼€å‘ä¸è¿ç»´ä¹‹é—´çš„çŸ›ç›¾
* åœ¨å¼€å‘ä¸è¿ç»´ä¹‹é—´æ­å»ºäº†ä¸€ä¸ªæ¡¥æ¢ï¼Œæ˜¯å®ç° devops çš„æœ€ä½³
è§£å†³æ–¹æ¡ˆ

### ä»€ä¹ˆæ˜¯å®¹å™¨

* å¯¹è½¯ä»¶å’Œå…¶ä¾èµ–çš„æ ‡å‡†åŒ–æ‰“åŒ…
* åº”ç”¨ä¹‹é—´ç›¸äº’éš”ç¦»
* å…±äº«åŒä¸€ä¸ªOS kernel
* å¯ä»¥è¿è¡Œåœ¨å¾ˆå¤šä¸»æµæ“ä½œç³»ç»Ÿä¹‹ä¸Š

### å®¹å™¨å’Œè™šæ‹Ÿæœºçš„åŒºåˆ«

* å®¹å™¨æ˜¯Appå±‚é¢çš„éš”ç¦»
* è™šæ‹ŸåŒ–æ˜¯ç‰©ç†èµ„æºå±‚é¢çš„éš”ç¦»

<img alt="Containers" src="https://docs.docker.com/images/Container%402x.png" width="300" height="300">&nbsp;&nbsp;&nbsp;<img alt="virtual machines" src="https://docs.docker.com/images/VM%402x.png" width="300" height="300">

### è™šæ‹ŸåŒ– + å®¹å™¨

### Docker 

å®¹å™¨æŠ€æœ¯çš„ä¸€ç§å®ç°

### Mac ä¸Š Docker å®‰è£…

[Install Docker Desktop for Mac](https://docs.docker.com/docker-for-mac/install/)

**What the install includes: The installation provides Docker Engine, Docker CLI client, Docker Compose, Docker Machine, and Kitematic.**

```sh
docker --version
docker version
```

### Vagrant + VirtualBoxæ­å»ºå®éªŒç¯å¢ƒ
**Development Environments Made Easy**

å…ˆå®‰è£… [VirtualBox](https://www.virtualbox.org/wiki/Downloads)

æ¥ä¸‹çœ‹ Vagrant å…¥é—¨æŒ‡å—->[Getting Started](https://www.vagrantup.com/intro/getting-started/index.html)

[Vagrant Cloud](https://app.vagrantup.com/boxes/search)
* [centos/7 Vagrant box](https://app.vagrantup.com/centos/boxes/7)

```sh
vagrant --help

vagrant init centos/7 # åˆ›å»ºäº†ä¸€ä¸ª Vagrantfile

more Vagrantfile # æè¿°äº†æˆ‘ä»¬è¦åˆ›å»ºçš„è™šæœº

vagrant up # å»æ‰¾ base box(local or cloud)
vagrant ssh # è¿›å…¥è™šæœº
sudo yum update # æ›´æ–°è™šæœº
exit # é€€å‡ºè™šæœº

vagrant status # æŸ¥çœ‹è™šæœºçŠ¶æ€
vagrant halt # åœæ‰è™šæœº

vagrant status # poweroff

vagrant destroy # åˆ æ‰è™šæœº
```

åˆ›å»ºä¸€å°è™šæœºåªéœ€ä¸€ä¸ª `Vagrantfile` æ–‡ä»¶å³å¯

å¯ä»¥ google æœç´¢ Vagrantfile å¦‚ï¼š`Vagrantfile CentOS`

åˆ›å»ºä¸€å°è™šæœºåªéœ€ä¸€ä¸ª `Vagrantfile` æ–‡ä»¶å³å¯

[CentOS ä¸­å®‰è£… Docker, ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/install/linux/docker-ce/centos/) 

```sh
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

sudo yum install -y yum-utils device-mapper-persistent-data lvm2

sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

sudo yum install docker-ce

sudo systemctl start docker

sudo docker version # æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯

sudo docker run hello-world # éªŒè¯ä¸€ä¸‹
```

åœ¨ Vagrantfile ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å¯ä»¥é…ç½®æœºå™¨å¯åŠ¨æ—¶è‡ªåŠ¨å®‰è£…å¥½Docker

```sh
config.vm.provision "shell", inline: <<-SHELL
  sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine
  sudo yum install -y yum-utils device-mapper-persistent-data lvm2
  sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  sudo yum install docker-ce
  sudo systemctl start docker
SHELL
```

ç½‘ç»œä¸‹è½½å¤ªæ…¢ï¼Œé€šè¿‡ `vagrant up` æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿åˆ° box çš„ä¸‹è½½åœ°å€ï¼Œç„¶åè¿…é›·ä¸‹è½½

ç¦»çº¿å®‰è£… centos7 box

```sh
cd ~/Vagrant/CentOS7 # æ‰¾åˆ°ä¸€ä¸ªç›®å½•ï¼Œä½œä¸ºåˆå§‹åŒ–ç›®å½•
vagrant box add centos/7 ~/Downloads/virtualbox.box # å»ºè®®é‡‡å–ç¦»çº¿å®‰è£…ï¼Œè¿™æ ·æœ‰åˆ©äºæ”¾ç½®è™šæ‹Ÿæœºæ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„
vagrant init centos/7 # åˆå§‹åŒ– Vagrantfile
vagrant up #å¯åŠ¨
vagrant ssh #è¿›å…¥VM
exit #é€€å‡º
vagrant status #æŸ¥çœ‹çŠ¶æ€
vagrant halt #åœæ‰
vagrant status #æŸ¥çœ‹çŠ¶æ€
vagrant destroy #åˆ æ‰æœºå™¨
```

æŸ¥çœ‹boxes

```sh
cd ~/.vagrant.d/boxes
```
### Docker Machine

[Docker Machine Overview](https://docs.docker.com/machine/overview/)

mac é»˜è®¤å°±å·²ç»å®‰è£…å¥½äº†

```sh
docker-machine version
```

Docker Machine èƒ½å¹²ä»€ä¹ˆï¼Ÿ(å¦‚ï¼šæœ¬åœ°å¿«é€Ÿåœ¨ VirtualBox ç¯å¢ƒä¸­åˆ›å»ºä¸€å°å…·æœ‰ Docker ç¯å¢ƒçš„æœºå™¨)

```sh
docker-machine --help # ä¹ æƒ¯çœ‹å¸®åŠ©

docker-machine create demo # æˆ‘æœ¬åœ°æ˜¯ç›´æ¥åœ¨ VirtualBox åˆ›å»ºä¸€ä¸ªå·²ç»å®‰è£…å¥½äº†çš„è™šæ‹Ÿæœº

docker-machine ls # çœ‹çœ‹å·²ç»å®‰è£…å¥½äº†çš„æœºå™¨
docker-machine ssh demo # è¿›å…¥åˆ°æœºå™¨é‡Œé¢
docker version
exit # é€€å‡º

docker-machine help # æŸ¥çœ‹å¸®åŠ©å‘½ä»¤

docker-machine create demo1 # å†åˆ›å»ºä¸€å°
docker-machine ls # çœ‹ä¸€ä¸‹
docker-machine stop demo1 # åœæ‰ demo1
docker-machine ls # å†çœ‹ä¸€ä¸‹è¾“å‡º
docker-machine stop demo # åœæ‰ demo
```

### åšä¸ªè¯•éªŒï¼Œè¿œç¨‹ç®¡ç†ä½ çš„ docker machine

å…ˆé€€å‡ºæœ¬åœ° mac å¯åŠ¨ docker server

```sh
docker version #çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯è¿ä¸ä¸Š server
docker-machine start demo #å¯åŠ¨ä¸‹ demo
docker-machine env demo #æš´éœ²å‡ºç¯å¢ƒå˜é‡

eval $(docker-machine env demo)
docker version #å‘ç°è¿ä¸Šäº†ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¿œç¨‹ç®¡ç† docker machine, æœ¬åœ°åªè¦ä¸€ä¸ª client å°±å¥½äº†
```

è¯¦ç»†æ–‡æ¡£ [Provision hosts in the cloud](https://docs.docker.com/machine/get-started-cloud/)

### é˜¿é‡Œäº‘ä¸Šåˆ›å»ºä¸€å° Docker Machine

[Drivers for cloud providers](https://docs.docker.com/machine/drivers/)

[3rd-party driver plugins](https://github.com/docker/docker.github.io/blob/master/machine/AVAILABLE_DRIVER_PLUGINS.md)

ä»“åº“åœ°å€ï¼š[Docker Machine Driver of Aliyun ECS](https://github.com/AliyunContainerService/docker-machine-driver-aliyunecs)

`README.md` æœ‰å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ŒğŸ‘‡ç®€çŸ­è¯´ä¸€ä¸‹ï¼š

ä¸‹è½½å¯¹åº”çš„ Driver, Mac OSX 64 bit: [docker-machine-driver-aliyunecs_darwin-amd64](https://docker-machine-aliyunecs-drivers.oss-cn-beijing.aliyuncs.com/docker-machine-driver-aliyunecs_darwin-amd64.tgz)

é‡å‘½å binary æ¡£ä¸º `docker-machine-driver-aliyunecs`ï¼Œç„¶åç§»åŠ¨åˆ° `/usr/local/bin`

éªŒè¯ä¸€ä¸‹ï¼ŒDriver æ˜¯å¦å®‰è£…æˆåŠŸ
```sh
docker-machine create -d aliyunecs --help
```

è¿›å…¥é˜¿é‡Œäº‘åå°ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥ `accesskeys` è¿›è¡Œåˆ›å»ºç”¨æˆ· AccessKey ID

å¥½çš„æ–¹å¼è¿˜æ˜¯ç›´æ¥æ ¹æ®æç¤ºæŒ‰ç…§ `ä½¿ç”¨å­ç”¨æˆ· AccessKey` æ–¹å¼åˆ›å»º

![aliyun-access-key](./images/aliyun-accesskey.png)

**æ³¨æ„ï¼šè¦åœ¨æ§åˆ¶å°æ·»åŠ å¥½å­è´¦å·æƒé™å’Œå……å€¼100+**

```sh
docker-machine create -d aliyunecs --aliyunecs-io-optimized=optimized --aliyunecs-access-key-id=<your key> --aliyunecs-access-key-secret=<your secret> --aliyunecs-region=cn-qingdao devops

docker-machine ssh devops # è¿›å…¥ shell
docker-machine env devops
eval $(docker-machine env devops)
docker version # çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰è¿ä¸Šè¿œç«¯çš„ server

docker-machine env --help # æŸ¥çœ‹ä¸‹å¸®åŠ©
docker-machine env --unset # å»æ‰åˆšè®¾çš„ç¯å¢ƒå˜é‡
eval $(docker-machine env --unset) 

docker version
```

**åº”ç”¨ï¼š**ï¼Œç¬é—´åˆ› 20 å°æœºå™¨å»åš`å•¦å•¦å•¦ğŸ˜‹ğŸ˜â€¦â€¦` ï¼Œåšå®Œç„¶åé”€æ¯ğŸ¤£

### Online Docker Playground

[Play with Docker](https://labs.play-with-docker.com/)

![Play with Docker](./images/play-with-docker.png)

### Docker æ¶æ„å’Œåº•å±‚æŠ€æœ¯

Docker Platform

* Docker æä¾›äº†ä¸€ä¸ªå¼€å‘ï¼Œæ‰“åŒ…ï¼Œè¿è¡Œ app çš„å¹³å°
* æŠŠ app å’Œåº•å±‚ infrastructure éš”ç¦»å¼€æ¥

Docker Engine

* åå°è¿›ç¨‹(dockerd)
* REST API Server
* CLI æ¥å£(docker)

```sh
vagrant ssh
sudo docker version
ps -ef | grep docker # çœ‹åˆ°æœ‰dockerdçš„è¿›ç¨‹
```

Docker Architecture

Client
* docker build
* docker pull
* docker run

DOCKER_HOST
* Docker daemon
* Containers
* Images

Registry
* Ubuntu
* Redis
* Niginx
* ...images

åº•å±‚æŠ€æœ¯çš„æ”¯æŒ
* Namespacesï¼šåšéš”ç¦» pid, net, ipc, mnt, uts
* Control groups: åšèµ„æºé™åˆ¶
* Union file systems: Container å’Œ Image åˆ†å±‚

### ä»€ä¹ˆæ˜¯ Image

* æ–‡ä»¶å’Œ meta data çš„é›†åˆ(root filesystem)
* åˆ†å±‚çš„ï¼Œå¹¶ä¸”æ¯ä¸€å±‚éƒ½å¯ä»¥æ·»åŠ æ”¹å˜ï¼Œåˆ é™¤æ–‡ä»¶ï¼Œæˆä¸ºä¸€ä¸ªæ–°çš„ image
* ä¸åŒçš„ image å¯ä»¥å…±äº«ç›¸åŒçš„ layer
* Image æœ¬èº«æ˜¯ read-only çš„

```sh
vagrant ssh
sudo docker image ls #åˆ—ä¸¾å‡ºæœ¬åœ°æœ‰çš„image
```

Image çš„è·å–

* Build from Dockerfile
* Pull from Registry
  ```sh
  sudo docker image ls
  sudo docker pull ubuntu:14.04
  sudo docker image ls
  ```
### Docker Hub

[Docker Hub Quickstart](https://docs.docker.com/docker-hub/)

[hub.docker.com](https://hub.docker.com/)

### Base Image

åœ¨Vagrantä¸­ï¼Œè§£å†³å½“å‰ç”¨æˆ· `docker` å‰è¦åŠ  `sudo` çš„é—®é¢˜

```sh
sudo groupadd docker # å®è´¨ä¸Šå®‰è£…å¥½ docker åï¼Œå®ƒå·²ç»å­˜åœ¨äº†
sudo gpasswd -a vagrant docker # å°†å½“å‰ç”¨æˆ·æ·»åŠ è¿™ä¸ªgroupé‡Œé¢
sudo service docker restart # æ³¨æ„ä¹‹åè¦é‡å¯ docker è¿›ç¨‹

exit # é€€å‡º,é‡æ–°ç™»å½•
vagrant ssh
docker image ls # ç°åœ¨å°±ä¸ç”¨åŠ  sudo äº†
```

é¦–å…ˆçœ‹ä¸€çœ‹ `hello-world` è¿™ä¸ª Base Image

```sh
docker pull hello-world #  è¿™ä¹Ÿæ˜¯ä¸€ä¸ª base imageï¼Œä»…ä»…åŒ…å«ç±»ä¼¼äºä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„æ–‡ä»¶

docker image ls # å‘ç°è¿™ä¸ªImageåªæœ‰1.85kbï¼Œéå¸¸éå¸¸å°

docker run hello-world # è¿™æ ·å°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨ï¼ˆæ‰§è¡Œä¸€ä¸ªImage)
```

### åˆ¶ä½œ `Hello-Docker` Base Image

```sh
# vagrant ssh
# å®‰è£…ä¸€äº›å¿…è¦çš„åŒ…
sudo yum install git
sudo yum install vim

mkdir hello-docker
cd hello-docker/
vim hello.c
#   #include<stdio.h>
#   int main()
#   {
#      printf("hello docker\n");
#   }

:wq # ä¿å­˜é€€å‡º Vim ç¥å™¨

history | grep yum # çœ‹ä¸€ä¸‹å®‰è£…å†å²

# å®‰è£…ç¼–è¯‘å™¨å’Œé™æ€ç‰ˆæœ¬åº“
sudo yum install gcc
sudo yum install glibc-static

gcc -static hello.c -o hello # ç¼–è¯‘

ls # å‘ç°å¤šäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶`hello`
./hello # æ‰§è¡Œä¸€æ¬¡çœ‹ä¸€ä¸‹

```

ç°åœ¨ï¼Œå°±å¯ä»¥ç”¨ Dockerfile æŠŠå®ƒå¼„æˆä¸€ä¸ª Docker Image

```yaml
FROM scratch # å› ä¸ºæ˜¯base image,æ‰€ä»¥è¿™é‡Œä¸èƒ½æ˜¯å…¶å®ƒ
ADD hello / # å°†è¿™ä¸ª`hello`æ·»åŠ åˆ°æ ¹ç›®å½•
CMD ["/hello"] # æ‰§è¡Œå®ƒ
```

```sh
# æ„å»º ç„¶åæ‰“ tagï¼Œåœ¨å½“å‰ç›®å½•ä¸‹æ‰¾Dockerfileï¼Œå› ä¸ºæœ‰ä¸‰æ­¥ï¼Œæ‰€ä»¥è¿™ä¸ªImageæœ‰ä¸‰å±‚
docker build -t kirkwwang/hello-docker .

docker image ls # çœ‹ä¸€ä¸‹,å‘ç°è¿™ä¸ªImageåªæœ‰857KB

ls -lh # çœ‹ä¸€ä¸‹`hello`è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶,åªæœ‰837KB

docker history b3a43698719c # çœ‹ä¸€ä¸‹è¿™ä¸ªimageæœ‰å‡ å±‚ï¼Œå‘ç°æ˜¯ä¸¤å±‚ï¼Œå› ä¸ºFROM scratchæœ¬èº«å°±æ²¡æœ‰FROMå…¶å®ƒImage,å¯ä»¥ä¸ç®—ä½œä¸€å±‚

docker run kirkwwang/hello-docker # è¿è¡Œçœ‹ä¸€ä¸‹ï¼Œéº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨
```

### ä»€ä¹ˆæ˜¯ Container

* é€šè¿‡ Image å»åˆ›å»º(copy)
* åœ¨ Image Layer ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ª container layer(å¯è¯»å†™)
* ç±»æ¯”é¢å‘å¯¹è±¡ï¼šç±»å’Œå®ä¾‹
* Image è´Ÿè´£ app å­˜å‚¨å’Œåˆ†å‘ï¼ŒContainer è´Ÿè´£è¿è¡Œ app

```sh
docker container ls # æŸ¥çœ‹å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨
docker container ls -a # æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨ï¼ˆæ­£åœ¨è¿è¡Œçš„ä»¥åŠé€€å‡ºçš„ï¼‰

more hello-docker/Dockerfile # çœ‹CMDé‚£ä¸€è¡Œï¼Œå½“æˆ‘ä»¬ docker run çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šå»æ‰§è¡Œ CMD é‡Œé¢çš„å‘½ä»¤

docker run centos # é»˜è®¤ä¼šç”¨latestç‰ˆæœ¬
docker container ls -a # å®ƒé»˜è®¤æ‰§è¡Œçš„æ˜¯/bin/bashï¼Œä½†ä¹Ÿä¼šé€€å‡ºï¼Œä¸æ˜¯äº¤äº’å¼è¿è¡Œï¼Œä¸å¸¸é©»å†…å­˜

docker run --help # æ³¨æ„çœ‹å¸®åŠ© -iï¼Œ-t

docker run -it centos # å‘ç°æˆ‘ä»¬è¿›å…¥åˆ°äº†å®¹å™¨é‡Œé¢
touch test.txt # å¤šäº†ä¸€ä¸ªå¯è¯»å¯å†™çš„ container layer,æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶
ls
yum install vim # å†æ‰§è¡Œä¸€æ¡å®‰è£…å‘½ä»¤
```

å¼€ä¸ªæ–°çš„terminal

```sh
cd ~/Vagrant/CentOS7
vagrant ssh
docker container ls # å‘ç°æœ‰æ­£åœ¨è¿è¡Œå®¹å™¨ centosï¼ŒCOMMAND æ˜¯ /bin/bash
```

é€€å‡ºå®¹å™¨

```sh
exit # é€€å‡ºè¿™ä¸ªå®¹å™¨
docker container ls # çœ‹ä¸åˆ°æ­£åœ¨è¿è¡Œçš„å®¹å™¨äº†
docker container ls -a
```

Docker çš„å‘½ä»¤åˆ†ä¸ºä¸¤å¤§å—ï¼šManagement Commands & Commands

Management Commands ï¼šä¸»è¦æ˜¯å¯¹Dockeré‡Œé¢çš„å…·ä½“å¯¹è±¡è¿›è¡Œç®¡ç†

```sh
docker image # çœ‹ä¸€ä¸‹imageä¸‹åˆæœ‰é‚£ä¸€äº›å‘½ä»¤
docker image ls
docker container # çœ‹ä¸€ä¸‹containerä¸‹åˆæœ‰é‚£ä¸€äº›å‘½ä»¤
docker container ls -a
docker container rm dfc145ac218f
docker container rm 3e # id æ— éœ€å†™å…¨
```

Commandsï¼šæä¾›ä¸€äº›ç®€ä¾¿æ–¹æ³•ï¼Œä¸ç”¨å‘½ä»¤å†™çš„å¤ªé•¿

```sh
docker ps #  == docker container ls
docker ps -a #  == docker container ls -a
docker rm cf # == docker container rm cf
docker images # == docker image ls
docker rmi fce289e99eb9 # docker image rm fce289e99eb9
```

å¦‚ä½•ä¸€æ¬¡æ€§æ¸…ç†æ‰æ‰€æœ‰çš„å®¹å™¨?

```sh
docker run kirkwwang/hello-docker # å…ˆåˆ›å»º5ä¸ªcontainer
docker run kirkwwang/hello-docker
docker run kirkwwang/hello-docker
docker run kirkwwang/hello-docker
docker run kirkwwang/hello-docker

docker ps -a # çœ‹ä¸€ä¸‹å…¨éƒ¨

docker container ls -aq # åˆ—ä¸¾å‡ºæ‰€æœ‰çš„id
docker container ls -a | awk {'print$1'} # æ‰“å°å‡ºç¬¬ä¸€åˆ—
docker rm $(docker container ls -aq) # å…¨éƒ¨æ¸…ç† == docker rm $(docker ps -aq)

# åªæ¸…ç†å·²ç»é€€å‡ºçš„
docker run kirkwwang/hello-docker # å…ˆ run 5 ä¸ª
docker container ls -f "status=exited" # åˆ—å‡ºé€€å‡ºçš„å®¹å™¨
docker container ls -f "status=exited" -q # åˆ—ä¸¾å‡ºæ‰€æœ‰çš„id
docker rm $(docker container ls -f "status=exited" -q) # åªæ¸…ç†å·²ç»é€€å‡ºçš„
docker rm $(docker ps -f "status=exited" -q) # åŒæ ·çš„æ•ˆæœ
```

### åŸºäºä¸€ä¸ª Container æ„å»º Image

åŸºäºæŸä¸ª Image åˆ›å»ºä¸€ä¸ª Container, ç„¶ååœ¨è¿™ä¸ª Container é‡Œé¢åšä¸€äº›å˜åŒ–ï¼Œå¦‚ï¼šå®‰è£…äº†æŸä¸ªè½¯ä»¶

æŠŠè¿™ä¸ªå·²ç»æ”¹å˜äº†çš„ Containerï¼Œ Commit æˆä¸€ä¸ªæ–°çš„ Image

```sh
# vagrant ssh
docker image ls
docker run -it centos
yum install -y vim
vim # ç„ä¸€çœ¼
exit # é€€å‡º
docker container ls -a # çœ‹åˆ°ä¸€ä¸ªé€€å‡ºçŠ¶æ€çš„ centos

docker commit # çœ‹ä¸€çœ¼è¿™ä¸ªå‘½ä»¤æ¥æ”¶å“ªäº›å‚æ•°
docker commit elastic_dewdney kirkwwang/centos-vim # elastic_dewdney ç”¨çš„NAMESï¼Œkirkwwang/centos-vim è¿™ä¸ªç”¨çš„tagé»˜è®¤æ˜¯latest

docker image ls # çœ‹ä¸€çœ¼images

# æ¯”è¾ƒä¸€ä¸‹ centos ä¸ kirkwwang/centos-vim çš„åˆ†å±‚
docker history centos
docker history kirkwwang/centos-vim # OK, å‘ç°æœ‰vimçš„å¤šäº†ä¸€å±‚ï¼Œå…¶å®ƒçš„éƒ½æ˜¯å…±äº«åŸæ¥çš„
```

**ä¸æå€¡è¿™ç§æ–¹å¼åˆ›å»º Imageã€‚å‘å¸ƒå‡ºå»ï¼Œå…¶å®å¹¶ä¸çŸ¥é“è¿™ä¸ª Image æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼ˆé¬¼çŸ¥é“ä½ é‡Œé¢å®‰è£…å•¥è½¯ä»¶[ç—…æ¯’]ï¼‰ï¼Œä¸å®‰å…¨**

### é€šè¿‡ Dockerfile å»æ„å»ºä¸€ä¸ª Image

```sh
docker image ls
docker image rm kirkwwang/centos-vim # åˆ æ‰åˆšåˆ›å»ºçš„image

mkdir docker-centos-vim
cd docker-centos-vim
vim Dockerfile
```

`Dockerfile` æ–‡ä»¶å†…å®¹

```yml
FROM centos
RUN yum install -y vim
# ä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ Container è¿è¡Œå‘½ä»¤ï¼Œç„¶åå» Commit æˆä¸€ä¸ªæ–°çš„ Image
# æœ€ååˆ æ‰é‚£ä¸ªä¸´æ—¶çš„ Container
```

```sh
docker build -t kirkwwang/centos-vim-new . # -t æ‰“ tag, `.`åŸºæœ¬äºå½“å‰ç›®å½•çš„Dockerfileæ„å»º

docker image ls # çœ‹ä¸€çœ¼æ–°ç”Ÿæˆçš„ image
```

### Dockerfile æœ€ä½³å®è·µ

[Best practices for writing Dockerfiles](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)

**FROM**

```yml
FROM scratch # åˆ¶ä½œ Base Image
FROM centos # ä½¿ç”¨ Base Image
FROM ubuntu:14.04
```

`ä¸ºäº†å®‰å…¨ï¼Œå°½é‡ä½¿ç”¨å®˜æ–¹çš„ Image ä½œä¸º Base Imageï¼`

**LABEL**

```yml
LABEL maintainer="kirk.w.wang@gmail.com"
LABEL version="1.0"
LABEL description="This is description"
```

LABEL ç±»ä¼¼äºæ³¨é‡Š

`Metadataä¸å¯å°‘`

**RUN**

```yml
RUN yum update && yum install -y vim \
    python-dev # åæ–œçº¿æ¢è¡Œ

RUN apt-get update && apt-get install -y perl \
    pwgen --no-install-recommends && rm -rf \
    /var/lib/apt/lists/* # æ³¨æ„æ¸…ç†cache

RUN /bin/bash -c 'source $HOME/.bashrc;echo 
$HOME'
```
`ä¸ºäº†ç¾è§‚ï¼Œå¤æ‚çš„RUNè¯·ç”¨åæ–œçº¿æ¢è¡Œï¼é¿å…æ— ç”¨åˆ†å±‚ï¼Œåˆå¹¶å¤šæ¡å‘½ä»¤æˆä¸€è¡Œï¼`

**WORKDIR è®¾å®šå½“å‰å·¥ä½œç›®å½•**

```yml
WORKDIR /root

WORKDIR /test # å¦‚æœæ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»ºtestç›®å½•
WORKDIR demo
RUN pwd # è¾“å‡ºç»“æœåº”è¯¥æ˜¯ /test/demo
```

`ç”¨WORKDIRï¼Œä¸è¦ç”¨ RUN cdï¼å°½é‡ä½¿ç”¨ç»å¯¹ç›®å½•ï¼`

**ADD and COPY**

```yml
ADD hello /
ADD test.tar.gz / #æ·»åŠ åˆ°æ ¹ç›®å½•å¹¶è§£å‹

WORKDIR /root
ADD hello test/ # /root/test/hello

WORKDIR /root
COPY hello test/
```

`å¤§éƒ¨åˆ†æƒ…å†µï¼ŒCOPY ä¼˜äº ADD! ADD é™¤äº† COPY è¿˜æœ‰é¢å¤–åŠŸèƒ½ï¼ˆè§£å‹ï¼‰ï¼æ·»åŠ è¿œç¨‹æ–‡ä»¶/ç›®å½•è¯·ä½¿ç”¨curlæˆ–è€…wget!`

**ENV**

```yml
ENV MYSQL_VERSION 5.6 # è®¾ç½®å¸¸é‡
RUN apt-get install -y mysql-server="${MYSQL_VERSION}" \
    && rm -rf /var/lib/apt/lists/* # å¼•ç”¨å¸¸é‡

ENV
```

`å°½é‡ä½¿ç”¨ENVå¢åŠ å¯ç»´æŠ¤æ€§`

**VOLUME and EXPOSE**

å­˜å‚¨å’Œç½‘ç»œ

**CMD and ENTRYPOINT**

### Dockerfile å­¦ä¹ æ–¹å¼

[docker-library](https://github.com/docker-library)

[Dockerfile reference](https://docs.docker.com/engine/reference/builder/)

### RUN vs CMD vs Entrypoint

RUN:æ‰§è¡Œå‘½ä»¤å¹¶åˆ›å»ºæ–°çš„Image Layer

CMD:è®¾ç½®å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°

ENTRYPOINT:è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤

Shell å’Œ Execæ ¼å¼

```sh
RUN apt-get install -y vim
CMD echo "hello docker"
ENTRYPOINT echo "hello docker"
```

Execæ ¼å¼

```sh
RUN["apt-get", "install", "-y", "vim"]
CMD["/bin/echo", "hello docker"]
ENTRYPOINT["/bin/echo", "hello docker"]
```

Dockerfile1

```sh
FROM centos
ENV name Docker
ENTRYPOINT echo "hello $name"
```

Dockerfile2

```sh
FROM centos
ENV name Docker
ENTRYPOINT ["/bin/echo", "hello $name"]
```

Demo

```sh
mkdir cmd_vs_entrypoint
cd cmd_vs_entrypoint
vim Dockerfile # æ”¾è¿›å»Dockerfile1
docker build -t kirkwwang/centos-entrypoint-shell . # shellæ ¼å¼æ„å»º
docker image ls
docker run kirkwwang/centos-entrypoint-shell # è¿è¡Œçœ‹ä¸€ä¸‹


vim Dockerfile # æ”¾è¿›å»Dockerfile2
docker build -t kirkwwang/centos-entrypoint-exec . # execæ ¼å¼æ„å»º
docker image ls
docker run kirkwwang/centos-entrypoint-exec
# [vagrant@bogon cmd_vs_entrypoint]$ docker run kirkwwang/centos-entrypoint-exec
# hello $name // å‘ç°å¹¶æ²¡æœ‰è¿›è¡Œå˜é‡æ›¿æ¢ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ˜¯åœ¨shellé‡Œé¢å»æ‰§è¡Œ echoï¼Œåªæ˜¯å•çº¯çš„æ‰§è¡Œecho, æ€ä¹ˆæ”¹ï¼Ÿ
# ENTRYPOINT ["/bin/bash","-c","echo","hello $name"] åœ¨ shell é‡Œé¢æ‰§è¡Œ echo å‘½ä»¤

vim Dockerfile # ä¿®æ”¹ä¸€ä¸‹
docker build -t kirkwwang/centos-entrypoint-exec-new .
docker image ls
docker run kirkwwang/centos-entrypoint-exec-new # å‘ç°æ‰“å°å‡ºæ¥çš„æ˜¯ç©ºï¼ŒWhyï¼Ÿ
# [vagrant@bogon cmd_vs_entrypoint]$ docker run kirkwwang/centos-entrypoint-exec-new
#

vim Dockerfile # ä¿®æ”¹ä¸€ä¸‹
# ENTRYPOINT ["/bin/bash","-c", "echo hello $name"] æŠŠåé¢æ‰€æœ‰çš„å‘½ä»¤ä½œä¸ºä¸€ä¸ªå»æ‰§è¡Œ

docker build -t kirkwwang/centos-entrypoint-exec-new .
docker run kirkwwang/centos-entrypoint-exec-new # ç°åœ¨å°±æ­£å¸¸äº†

```

### CMD

å®¹å™¨å¯åŠ¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤

å¦‚æœdocker runæŒ‡å®šäº†å…¶å®ƒå‘½ä»¤ï¼ŒCMDå‘½ä»¤è¢«å¿½ç•¥

å¦‚æœå®šä¹‰äº†å¤šä¸ªCMDï¼Œåªæœ‰æœ€åä¸€ä¸ªä¼šæ‰§è¡Œ

Dockerfile:

```yml
FROM centos
ENV name Docker
CMD echo "hello $name"
```

```sh
docker run [image] #è¾“å‡º?-->hello World
docker run -it [image] /bin/bash # è¾“å‡º?-->CMDå‘½ä»¤è¢«å¿½ç•¥ï¼Œå› ä¸ºæŒ‡å®šäº† `/bin/bash`
```

### ENTRYPOINT

è®©å®¹å™¨ä»¥åº”ç”¨ç¨‹åºæˆ–è€…æœåŠ¡çš„å½¢å¼è¿è¡Œ

ä¸ä¼šè¢«å¿½ç•¥ï¼Œä¸€å®šä¼šæ‰§è¡Œ

æœ€ä½³å®è·µï¼šå†™ä¸€ä¸ªshellè„šæœ¬ä½œä¸ºentrypoint

```yml
COPY docker-entrypoint.sh /usr/local/bin/
ENTRYPOINT ["docker-entrypoint.sh"] # å†™ä¸€ä¸ª shell script

EXPOSE 27017
CMD ["mongod"]
```

å®è·µ(å‘½ä»¤æ”¹æˆ shell)

```sh
docker rm $(docker ps -f "status=exited" -q) # å¹²æ‰å·²ç»é€€å‡ºçš„å®¹å™¨
docker rmi e2fc56ae6db7 # åˆ æ‰é‚£ä¸ª none Image

vim Dockerfile # ä¿®æ”¹ENTRYPOINTï¼šCMD echo "hello $name"

docker build -t kirkwwang/centos-cmd-shell . # æ„å»º

docker images # æŸ¥çœ‹ä¸€ä¸‹
docker run kirkwwang/centos-cmd-shell
#hello Docker

docker run -it kirkwwang/centos-cmd-shell /bin/bash # å‘ç°ç›´æ¥è¿›å…¥å®¹å™¨é‡Œé¢äº†

docker run kirkwwang/centos-entrypoint-shell #hello Docker

docker run -it kirkwwang/centos-entrypoint-shell /bin/bash
# hello Docker -->> è¿˜æ˜¯ä¼šè¿è¡Œ ENTRYPOINT
```

### é•œåƒçš„å‘å¸ƒ

[Docker Hub](https://hub.docker.com)

å®è·µ

```sh
# vagrant ssh
docker login

docker push kirkwwang/hello-docker # kirkwwang ä¸€å®šæ˜¯ä½ çš„ Docker Id

docker rmi kirkwwang/hello-docker # åˆ æ‰æœ¬åœ°çš„ï¼Œæ‹‰å–çº¿ä¸Šçš„

docker pull kirkwwang/hello-docker
```

è¿™æ ·å»å‘å¸ƒä¸€ä¸ª docker image æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºåˆ«äººä¸çŸ¥é“ä½ åœ¨ç³»ç»Ÿæ˜¯ä¸æ˜¯åŠ äº†ç—…æ¯’

æ¨èçš„æ–¹å¼æ˜¯å…³è” Github ä»“åº“ç­‰ï¼Œé‡Œé¢æä¾›Dockerfile, Docker Hub è‡ªåŠ¨å¸®æˆ‘ä»¬æ ¹æ® Dockerfile æ„å»º

[Create Repository](https://cloud.docker.com/repository/create)

### æ­å»ºç§æœ‰çš„ Registry

[registry](https://hub.docker.com/_/registry)

ç™»å½•å¦ä¸€å°æœºå™¨ï¼š

```sh
docker run -d -p 5000:5000 --restart always --name registry registry:2 # åˆ›å»ºä¸€ä¸ªå®¹å™¨è¿è¡ŒApp
```

æœ¬åœ°æµ‹è¯•ä¸€ä¸‹ï¼Œæ˜¯å¦èƒ½è¿å¾—ä¸Šæˆ‘ä»¬çš„ä¼ºæœå™¨ã€‚

```sh
sudo yum install -y telnet
telnet x.x.x.x 5000 # æœ¬åœ°æµ‹ä¸€ä¸‹
# Trying xx.xx.xx.xx...
# Connected to xx.x.x.x.
# Escape character is '^]'. 
# è¯´æ˜è¿æ¥æˆåŠŸäº†
```

å¾€ç§æœ‰çš„æœåŠ¡å™¨å»push

```sh
docker rmi kirkwwang/hello-world # å…ˆå¹²æ‰æœ¬åœ°çš„Image
docker build -t x.x.x.x:5000/hello-world . # x.x.x.x ä½ è‡ªå·±æœåŠ¡å™¨çš„ip
docker images
```

é…ç½®(å› ä¸ºé»˜è®¤æˆ‘ä»¬çš„æœåŠ¡å™¨æ˜¯ä¸å¯ä¿¡ä»»çš„)

```sh
sudo ls /etc/docker/ # è¿™ä¸ªç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶
sudo vim /etc/docker/daemon.json

sudo more /etc/docker/daemon.json
# {"insecure-registries":["x.x.x.x:5000"]} è®©è¿™ä¸ªæœåŠ¡å™¨å¯ä»¥ä¿¡ä»»çš„

sudo vim /lib/systemd/system/docker.service #ç¼–è¾‘å†™dockerçš„å¯åŠ¨æ–‡ä»¶ï¼ŒåŠ è½½åˆšåˆšçš„é…ç½®
# EnvironmentFile=-/etc/docker/daemon.json åŠ è¿™ä¹ˆä¸€è¡Œ

sudo service docker restart
#Redirecting to /bin/systemctl restart docker.service
#Warning: docker.service changed on disk. Run 'systemctl daemon-reload' to reload units.

sudo systemctl daemon-reload

docker push xx.xx.xx.xx:5000/hello-world ## å¥½ï¼Œçœ‹åˆ°æˆåŠŸäº†
```

å¦‚ä½•éªŒè¯æ¨é€æˆåŠŸäº†å‘¢ï¼Ÿ

[Docker Registry HTTP API V2](https://docs.docker.com/registry/spec/api/)

[listing-repositories](https://docs.docker.com/registry/spec/api/#listing-repositories)

```sh
[vagrant@bogon hello-world]$ curl x.x.x.x:5000/v2/_catalog
{"repositories":["hello-world"]}
```

å¦å¤–ä¸€ç§éªŒè¯æ¨é€æˆåŠŸçš„æ–¹å¼ï¼š

```sh
docker rmi x.x.x.x:5000/hello-world # åˆ æ‰æœ¬åœ°çš„
docker pull x.x.x.x:5000/hello-world
```

### Dockerfile å®æˆ˜

```sh
mkdir flask-hello-world
cd flask-hello-world/

vim app.py
```

```py
from flask import Flask
app = Flask(__name__)
@app.route('/')
def hello()
   return "hello docker"
if __name__== "__main__":
   app.run()
```

```sh
vim Dockerfile
```

```yml
FROM python:2.7
LABEL maintainer="Kirk Wang<kirk.w.wang@gmail.com>"
RUN pip install flask
COPY app.py /app
WORKDIR /app
EXPOSE 5000
CMD ["python", "app.py"]
```

### Debug Dockerfile
```sh
docker build -t kirkwwang/flask-hello-world .

# æ„å»º
# ....
# Step 4/7 : COPY app.py /app
# ---> 6e2811783304
# Step 5/7 : WORKDIR /app
# Cannot mkdir: /app is not a directory å°´å°¬ï¼ŒæŠ¥é”™ï¼Œè¿›å»è¿™ä¸ªä¸­é—´çŠ¶æ€çš„Image 6e2811783304 å»çœ‹ä¸€çœ¼

docker run -it 6e2811783304 /bin/bash # å‘ç° app æ˜¯ä¸ªæ–‡ä»¶

vim Dockerfile # ä¿®æ”¹ COPY app.py /app -> COPY app.py /app/
```

```yml
FROM python:2.7
LABEL maintainer="Kirk Wang<kirk.w.wang@gmail.com>"
RUN pip install flask
COPY app.py /app/
WORKDIR /app
EXPOSE 5000
CMD ["python", "app.py"]
```

```sh
docker build -t kirkwwang/flask-hello-world . # æ„å»º
docker images # çœ‹åˆ°äº† kirkwwang/flask-hello-world
docker run kirkwwang/flask-hello-world # åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œè¿è¡Œæˆ‘ä»¬çš„ App
docker run -d kirkwwang/flask-hello-world # -d åå°æ‰§è¡Œ
docker ps # å‘ç°æ­£åœ¨è¿è¡Œ
```

### å®¹å™¨çš„æ“ä½œ

å¯¹è¿è¡Œä¸­çš„å®¹å™¨è¿›è¡Œæ“ä½œ

```sh
docker ps
docker exec -it fdeee46afa69 /bin/bash # å¯¹æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ‰§è¡Œ/bin/bashï¼Œäº¤äº’å¼çš„è¿è¡Œ
ps -ef | grep python # å‘ç°æœ‰è¿›ç¨‹åœ¨åå°è¿è¡Œ

exit # é€€å‡º
docker exec -it fdeee46afa69 python # å‘ç°æˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°äº†ä¸€ä¸ªpythonçš„shellé‡Œé¢äº†

docker exec -it fdeee46afa69 ip a # æ‰“å°ä¸‹å®¹å™¨çš„ipåœ°å€

docker stop fdeee46afa69 # ==docker container stop fdeee46afa69 åœæ‰å®¹å™¨

docker rm $(docker ps -aq) # æ¸…ç†æ‰€æœ‰çš„å®¹å™¨
docker rm $(docker ps -f "status=exited" -q) # æ¸…ç†æ‰€æœ‰é€€å‡ºçš„å®¹å™¨

docker run -d --name=demo kirkwwang/flask-hello-world # é‡æ–°å¯åŠ¨å¹¶ä¸”åŠ ä¸ªåå­—

docker ps # çœ‹åˆ°äº†é‚£ä¸ªåå­—ï¼Œä¸æŒ‡å®šå°±éšæœºåˆ†é…ä¸€ä¸ª

docker stop demo # åœæ‰

docker start demo # å¯åŠ¨

docker inspect demo # æŸ¥çœ‹ä¸‹è¿™ä¸ªå®¹å™¨çš„è¯¦ç»†ä¿¡æ¯

docker logs demo # å®¹å™¨è¿è¡Œäº§ç”Ÿçš„ä¸€äº›è¾“å‡º
```

### æ‰“åŒ… Stress å‹åŠ›æµ‹è¯•å·¥å…·

ä½¿ç”¨ä¸€ä¸‹ Stress

```sh
mkdir ubuntu-stress
cd ubuntu-stress
docker run -it ubuntu # è¿è¡Œå¹¶è¿›å…¥åˆ°å®¹å™¨é‡Œé¢
apt-get update && apt-get install -y stress # å®‰è£… stress

which stress # åœ¨/usr/bin/stress
stress --help
stress --vm 1 --verbose # åˆ†é…&é‡Šæ”¾
stress --vm 1 --vm-bytes 5000000M --verbose # ç‚¸äº†ï¼Œè¶…å‡ºäº† docker host å†…å­˜çš„é™åˆ¶äº†
top # çœ‹ä¸‹å†…å­˜
```

æ‰“åŒ…
```sh
vim Dockerfile
```

```yml
FROM ubuntu
RUN apt-get update && apt-get install -y stress
ENTRYPOINT ["/usr/bin/stress"]
CMD [] # æ¥æ”¶å‚æ•°
```

```sh
docker build -t kirkwwang/ubuntu-stress . # æ„å»º
docker run -it kirkwwang/ubuntu-stress # å‘ç°æ‰“å°å‡ºäº†å¸®åŠ©ä¿¡æ¯
docker run -it kirkwwang/ubuntu-stress --vm 1 # stress æ¥å—äº†vmç­‰äº1çš„å‚æ•°
docker run -it kirkwwang/ubuntu-stress --vm 1 --verbose # æ‰“å°å‡ºæ‰€æœ‰çš„è¿‡ç¨‹
```

ENTRYPOINT + CMD æ¯”è¾ƒå…¸å‹åˆ©ç”¨ docker åœ¨å®¹å™¨é‡Œé¢è¿è¡Œå‘½ä»¤å·¥å…·çš„æ–¹æ³•

### å®¹å™¨çš„èµ„æºé™åˆ¶

é™åˆ¶å†…å­˜

```sh
docker run help ## --memory --memory-swap ä¸åšé™åˆ¶å°±ç­‰äº memory
docker run --memory=200M kirkwwang/ubuntu-stress --vm 1 --verbose 
# å¦‚æœåœä¸äº†ï¼Œæ–°å¼€ä¸€ä¸ª vagrant ssh -->docker stop
# --memory=200Mï¼Œå…¶å®æœ‰400M,å› ä¸º memory-swap æ²¡æŒ‡å®šå°±ç­‰äº memory
docker run --memory=200M kirkwwang/ubuntu-stress --vm 1 --verbose --vm-bytes 500M
## æ€»å…±æ‰400Mï¼ŒæŒ‡å®šäº†500Mï¼Œè‚¯å®šå°±ç‚¸äº†
```

é™åˆ¶CPU(æ³¨æ„è§‚å¯Ÿ)

shell 1
```sh
top
```

shell 2
```sh
docker run --cpu-shares=5 --name=test1 kirkwwang/ubuntu-stress --cpu 1
```

shell 3
```sh
docker run --cpu-shares=10 --name=test2 kirkwwang/ubuntu-stress --cpu 1
```

cpu-shares å»è®¾ç½®ç›¸å¯¹æƒé‡

### Docker Network 

å•æœºï¼šBridge Network  Host Network  None Network

å¤šæœºï¼šOverlay Network

**Vagrant was unable to mount VirtualBox shared folders.é”™è¯¯è§£å†³æ–¹å¼**

[è§£å†³æ–¹æ¡ˆ](https://github.com/scotch-io/scotch-box/issues/296)

```sh
vagrant plugin install vagrant-winnfsd
vagrant plugin install vagrant-vbguest
Vagrant up
```

å®æ“ï¼š

å¤–é¢æ˜¯å¯ä»¥pingçš„é€šçš„
```sh
ping 192.168.205.10
ping 192.168.205.11

vagrant status
vagrant ssh docker-node1 # è¿›å…¥ç¬¬ä¸€å°æœºå™¨
docker version
ip a
ping 192.168.205.11 #æ˜¯é€šçš„
```

å¦‚æœå®åœ¨è£…ä¸äº†å¯ä»¥ `docker machine`

### ç½‘ç»œåŸºç¡€å›é¡¾

*åŸºäºæ•°æ®åŒ…çš„é€šä¿¡æ–¹å¼*

*ç½‘ç»œçš„åˆ†å±‚*

*è·¯ç”±çš„æ¦‚å¿µ*

*IPåœ°å€å’Œè·¯ç”±*

*å…¬æœ‰IPå’Œç§æœ‰IP*

```
A 10.0.0.0 -> 10.255.255.255 (10.0.0.0/8)
B 172.16.0.0 -> 172.31.255.255 (172.16.0.0/12)
C 192.168.0.0 -> 192.168.255.255 (192.168.0.0/16)
```

*ç½‘ç»œåœ°å€è½¬æ¢NAT*

*Pingå’Œtelnet*

Ping(ICMP)ï¼šéªŒè¯IPçš„å¯è¾¾æ€§

telnet:éªŒè¯æœåŠ¡çš„å¯ç”¨æ€§

Wireshart å·¥å…·

### Linuxç½‘ç»œå‘½åç©ºé—´(Docker åº•å±‚æŠ€æœ¯)

åˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨(test1)ï¼ŒåŒæ—¶ä¹Ÿå°±åˆ›å»ºäº†ä¸€ä¸ª Linux Network Namespace, å’Œå®¿ä¸»æœºæˆ–å…¶å®ƒå®¹å™¨æ˜¯å®Œå…¨éš”ç¦»çš„
```sh
# vagrant ssh docker-node1
sudo docker run -d --name test1 busybox /bin/sh -c "while true; do sleep 3600; done" # è¿™ä¸ª container ä¼šä¸€ç›´åœ¨åå°è¿è¡Œ
```

æ˜¾ç¤ºå®¹å™¨(test1)æœ‰çš„ç½‘ç»œæ¥å£(å‘½åç©ºé—´)

```sh
sudo docker exec -it test1 /bin/sh # è¿›å…¥Container
ip a
```

æ˜¾ç¤ºå½“å‰å®¹å™¨(test1)æœ‰çš„ç½‘ç»œæ¥å£(å‘½åç©ºé—´) lo: æœ¬åœ°å›ç¯å£, eth0:

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
5: eth0@if6: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```

åˆ›å»ºå®¹å™¨(test2),ç„¶ååœ¨å®ƒé‡Œé¢å» ping å®¹å™¨(test1[172.17.0.2])
```sh
sudo docker run -d --name test2 busybox /bin/sh -c "while true; do sleep 3600; done"

docker ps # çœ‹ä¸€ä¸‹åˆ—è¡¨

sudo docker exec -it test2 /bin/sh # è¿›å…¥ test2
ip a # çœ‹ä¸€ä¸‹è‡ªå·±çš„ip

ping 172.17.0.2 # ping test1 å®¹å™¨ï¼Œæ˜¯èƒ½å¤Ÿé€šçš„

```

### åˆ›å»ºå’Œåˆ é™¤ Linux NetWork NameSpace

```sh
sudo ip netns list # æœ¬æœºæœ‰çš„network namespace
sudo ip netns delete test1 # åˆ æ‰
sudo ip netns add test1 # æ·»åŠ 
sudo ip netns list
sudo ip netns add test1
sudo ip netns list
```
æœ‰ä¸¤ä¸ª network namespace äº†

åˆšæ‰ç”¨ docker run åˆ›å»ºäº†ä¸¤ä¸ªå®¹å™¨ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ network namespace, å¯ä»¥é€šè¿‡ docker exec å»æŸ¥çœ‹ network namespace é‡Œé¢çš„ç«¯å£å’Œipåœ°å€

åŒç†ï¼Œæˆ‘ä»¬å¦‚ä½•å»æŸ¥çœ‹åˆšåˆš linux åˆ›å»ºçš„ network namespace å®ƒçš„ ip å‘¢ ï¼Ÿ
```sh
sudo ip netns exec test1 ip a # åœ¨ test1 è¿™ä¸ª
```
```
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```
çœ‹åˆ°ç°åœ¨æœ‰ä¸€ä¸ªæœ¬åœ°çš„å›ç¯å£ï¼Œç‰¹ç‚¹ï¼šæ²¡æœ‰127.0.0.1åœ°å€ï¼ŒçŠ¶æ€æ˜¯ `DOWN` çš„ï¼Œæ²¡æœ‰è¿è¡Œèµ·æ¥

è¿˜å¯ä»¥åœ¨`NetWork NameSpace`é‡Œé¢æ‰§è¡Œ `ip link` å‘½ä»¤
```sh
ip link # æœ¬æœºçœ‹ä¸€ä¸‹

sudo ip netns exec test1 ip link # åœ¨ test NS é‡Œé¢æ‰§è¡Œ
```

```
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```

åªæœ‰ä¸€æ¡lo(æœ¬åœ°å›ç¯å£)

å¥½ï¼Œç°åœ¨è®© lo è¿™ä¸ªç«¯å£ up èµ·æ¥
```sh
sudo ip netns exec test1 ip link set dev lo up
sudo ip netns exec test1 ip link #çœ‹ä¸€ä¸‹
```
ç°åœ¨å˜æˆ UNKNOWN äº†ï¼ŒWhy?
è¿™ä¸ªç«¯å£è¦UPèµ·æ¥ï¼Œè¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼Œéœ€è¦ä¸¤ç«¯æ˜¯è¿èµ·æ¥çš„ã€‚
å°±åƒ eth0 å’Œ mac é‡Œé¢çš„ä¸€ä¸ªè™šæ‹ŸåŒ–çš„ç«¯å£è¿èµ·æ¥ï¼Œå°±æ˜¯è¯´å•ä¸ªç«¯å£æ˜¯æ²¡æ³• up èµ·æ¥çš„ï¼Œå¿…é¡»æ˜¯ä¸€å¯¹ã€‚
```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```

### è®©ä¸¤ä¸ª NetWork NameSpace(test1 & test2) äº’é€š

æœ¬æœºæœ‰ä¸¤ä¸ª network namespace , test1 & test2ï¼Œå®ƒä»¬åˆ†åˆ«æœ‰ä¸€ä¸ªloobackæœ¬åœ°çš„å›ç¯å£

æƒ³è®© test1 å’Œ test2 è¿èµ·æ¥ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦æ¥å£ï¼ˆç±»ä¼¼äºè¿ä¸¤å°æœºå™¨éœ€è¦ç½‘çº¿, å¿…é¡»æ’åˆ°æ¯ä¸ªè®¡ç®—æœºçš„ç½‘å£ä¸Šå»)

åœ¨ Linux Network Namesapce æŠ€æœ¯é‡Œé¢,æˆ‘ä»¬æœ‰ Veth, æˆ‘ä»¬å¯ä»¥åˆ›å»º Veth pair

æœ‰äº†è¿™ä¸€å¯¹ï¼Œç„¶ååˆ†åˆ«æ”¾åœ¨ test1 ä¸ test2ï¼Œè¿™æ ·å°±è¿èµ·æ¥äº†ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªç«¯å£åˆ†åˆ«æ˜¯åœ¨ä¸¤ä¸ªnetwork namespace é‡Œé¢

æ‰€ä»¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ç»™è¿™ä¸¤ä¸ªç«¯å£éƒ½é…ä¸€ä¸ªIPåœ°å€çš„è¯ï¼Œé‚£ä¹ˆä»–ä»¬ä¸¤ä¸ªå°±æ˜¯é€šçš„äº†ï¼ˆå°±å¦‚å…ˆå‰åˆ›å»ºbusybox containerï¼Œå®ƒä»¬èƒ½pingé€šï¼ŒåŸç†ä¸€æ ·ï¼‰

1.åˆ›å»º Network Namespace
```sh
# vagrant

sudo ip netns list
sudo ip netns add test1
sudo ip netns add test2
```

2.åˆ›å»º Veth pair
```sh
sudo ip link add veth-test1 type veth peer name veth-test2 # æœ¬æœºæ·»åŠ ä¸€å¯¹link
ip link # çœ‹ä¸€ä¸‹
```

3.æ·»åŠ  veth pair åˆ° test1 & test2
```sh
sudo ip link set veth-test1 netns test1 # æŠŠ veth-test1 æ¥å£æ·»åŠ åˆ° test1 network namespace é‡Œé¢å»
sudo ip netns exec test1 ip link # çœ‹ä¸€ä¸‹
sudo ip link # çœ‹çœ¼æœ¬åœ°ï¼Œ10 ä¸è§äº†
sudo ip link set veth-test2 netns test2 # åŒç† ,test2
sudo ip link # çœ‹çœ¼æœ¬åœ°ï¼Œ9 ä¹Ÿä¸è§äº†ï¼Œå¥½ï¼Œå®Œç¾
sudo ip netns exec test2 ip link 
```

4.ä¸º test1 & test2 åˆ†é… ip
```sh
sudo ip netns exec test1 ip addr add 192.168.1.1/24 dev veth-test1 # ä¸º dev veth-test1 åˆ†é…ä¸€ä¸ªIPåœ°å€ï¼Œæ©ç æ˜¯24
sudo ip netns exec test2 ip addr add 192.168.1.2/24 dev veth-test2
```

5.Up test1 & test2 Network Namespace
```sh
sudo ip netns exec test1 ip link set dev veth-test1 up # æŠŠè¿™ä¸ªveth-test1ç«¯å£upèµ·æ¥
sudo ip netns exec test2 ip link set dev veth-test2 up # æŠŠè¿™ä¸ªveth-test2ç«¯å£upèµ·æ¥

sudo ip netns exec test1 ip link
sudo ip netns exec test2 ip link
```

6.Ping
```sh
sudo ip netns exec test1 ip a # çœ‹ä¸‹test1 ip
sudo ip netns exec test2 ip a # çœ‹ä¸‹test2 ip
sudo ip netns exec test1 ping 192.168.1.2 # åœ¨ test1 é‡Œé¢å» ping test2-->å®Œç¾ï¼Œé€šäº†
sudo ip netns exec test2 ping 192.168.1.1 # åŒç†
```

**ä»¥ä¸Šå°±æ˜¯ä¸Šé¢ä¸¤ä¸ª busybox å®¹å™¨èƒ½é€šçš„åŸç†**

### Docker bridge0 è¯¦è§£

```sh
sudo docker exec -it test1 /bin/sh # è¿›å…¥å®¹å™¨
ping www.baidu.com # æ˜¯èƒ½ ping é€šçš„ï¼Œ Why?
```

å®éªŒï¼š

```sh
docker ps
docker stop test2
docker rm test2 # åˆ æ‰test2ï¼Œåªä¿ç•™test1

docker network ls 
```
åˆ—ä¸¾å‡ºæ¥å½“å‰æœºå™¨ docker æœ‰å“ªäº›ç½‘ç»œ
```
NETWORK ID          NAME                DRIVER              SCOPE
858d0eaf1962        bridge              bridge              local
f770f4ae06ce        host                host                local
9f95ebeb5691        none                null                local
```

çœ‹ä¸€ä¸‹ test1 å®¹å™¨æ˜¯ä¸æ˜¯è¿æ¥åˆ° `bridge` è¿™ä¸ª DRIVER ä¸Šé¢
```sh
docker network inspect test1 #æŸ¥çœ‹bridgeè¯¦ç»†ä¿¡æ¯,å‘ç°test1æ˜¯è¿æ¥åˆ°äº†bridgeè¿™ä¸ªç½‘è·¯ä¸Šé¢çš„
docker network inspect bridge
```

æ³¨æ„ Container å­—æ®µ

```
"Containers": {
   "25337f3ec9bce578d970aee205b81d6b1d88415e003708884cef2df040f99160": {
         "Name": "test1",
         "EndpointID": "94452199f6ed1de0c7af747546f8559cdb0f08ed13a16f35fa7dca4d2c2f5602",
         "MacAddress": "02:42:ac:11:00:02",
         "IPv4Address": "172.17.0.2/16",
         "IPv6Address": ""
   }
}
```

çœ‹ä¸‹æœ¬æœºçš„ `ip a`

```
.....
.....
6: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:26:2a:af:cc brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:26ff:fe2a:afcc/64 scope link
       valid_lft forever preferred_lft forever
8: vetha023cb1@if7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default
    link/ether 7e:b6:31:7d:34:c1 brd ff:ff:ff:ff:ff:ff link-netnsid 2
    inet6 fe80::7cb6:31ff:fe7d:34c1/64 scope link
       valid_lft forever preferred_lft forever
```
OK, æˆ‘ä»¬çœ‹åˆ°äº† `docker0` å’Œ `vetha023cb1@if7`ã€‚æˆ‘ä»¬çš„ test1 container è¦è¿æ¥åˆ° docker0 è¿™ä¸ª bridge ä¸Šé¢ã€‚ docker0è¿™ä¸ªnetwork namespace æ˜¯æœ¬æœºï¼Œbusybox æœ‰è‡ªå·±çš„ network namespace, è¿™ä¸¤ä¸ªè¦è¿æ¥åœ¨ä¸€èµ·ï¼Œå°±éœ€è¦ä¸€ä¸ª veth çš„ pairã€‚

`vetha023cb1@if7` å°±è´Ÿè´£è¿åˆ° docker0 ä¸Šé¢çš„ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘çœ‹ä¸€ä¸‹ test1 å®¹å™¨çš„`ip a`
```sh
docker exec test1 ip a
```

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
7: eth0@if8: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```

è¿™ä¸ª eth0@if8 å’Œå¤–é¢çš„ vetha023cb1@if7 æ˜¯ä¸€å¯¹ï¼Œè¿™æ ·æˆ‘ä»¬ test1å®¹å™¨å°±è¿åˆ°äº† docker0 ä¸Šäº†ã€‚

å¦‚ä½•éªŒè¯æ˜¯è¿åˆ°äº† docker0 ä¸Šçš„ï¼Ÿå®‰è£…ä¸€ä¸ªå·¥å…· `brctl`
```sh
sudo yum install bridge-utils
brctl # çœ‹ä¸‹å¸®åŠ©
brctl show # çœ‹ä¸‹ interface
```
```
bridge name	   bridge id		      STP enabled	   interfaces
docker0		   8000.0242262aafcc	   no		         vetha023cb1
```
æ³¨æ„ `vetha023cb1` ä¸å‰é¢çš„ `vetha023cb1@if7`ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ¥å£æ˜¯è¿ä¸Šäº† Linux Bridge ä¸Šçš„

æ¥ä¸‹æ¥åˆ›å»º test2 container

```sh
sudo docker run -d --name test2 busybox /bin/sh -c "while true; do sleep 3600; done"
docker network inspect bridge # çœ‹åˆ°Containerséƒ¨åˆ†å¤šäº†ä¸€ä¸ª
```

```
"Containers": {
   "25337f3ec9bce578d970aee205b81d6b1d88415e003708884cef2df040f99160": {
         "Name": "test1",
         "EndpointID": "94452199f6ed1de0c7af747546f8559cdb0f08ed13a16f35fa7dca4d2c2f5602",
         "MacAddress": "02:42:ac:11:00:02",
         "IPv4Address": "172.17.0.2/16",
         "IPv6Address": ""
   },
   "efd1c8e17791b1fa2334a71f0bb81784bf936ef12f0386e3d7927e0a14925d7d": {
         "Name": "test2",
         "EndpointID": "978e256e484f4dcddaee26955a18707f74d676b9d5e7c26fe42c28ac6c0fce1a",
         "MacAddress": "02:42:ac:11:00:03",
         "IPv4Address": "172.17.0.3/16",
         "IPv6Address": ""
   }
},
```
`ip a`ï¼Œå†çœ‹ï¼Œå‘ç°å¤šäº†ä¸€ä¸ªvethï¼ŒWhy?å› ä¸ºæˆ‘ä»¬å¤šäº†ä¸ªå®¹å™¨ï¼Œå®ƒåˆéœ€è¦ä¸€å¯¹ï¼ˆä¸€æ ¹çº¿ï¼‰å»è¿è¿™ä¸ª docker0

`brctl show` å‘ç° docker0 è¿äº†ä¸¤ä¸ªæ¥å£äº†
```sh
bridge name	bridge id		   STP enabled	interfaces
docker0		8000.0242262aafcc	no		      vetha023cb1
							                     vethb15f768
```

å®¹å™¨ä¹‹é—´äº’è®¿

* Contianer Test1 <-> docker 0 <-> Contianer Test2

Internet

* Contianer Test1 -> docker 0 -> NAT -> eth0 -> Internet

### å®¹å™¨ä¹‹é—´çš„link(docker ä¹‹é—´çš„å…³ç³»)

IP æ˜¯ä¼šå˜çš„ï¼Œä½†åå­—ä¸ä¼šå˜

```sh
# vagrant
docker ps
docker stop test2
docker rm test2

docker run -d --name test2 --link test1 busybox /bin/sh -c "while true; do sleep 3600; done" # åŠ ä¸Šlinkå‚æ•°
docker exec -it test2 /bin/sh #è¿›å…¥å®¹å™¨

ping 172.17.0.2 # é€š
ping test1 # é€šï¼Œç›¸å½“äºæœ¬åœ°æ·»åŠ äº†ä¸€æ¡DNSè®°å½•ï¼Œåªæœ‰ test2 èƒ½è¿ test1
exit
```

`link` ä¸€èˆ¬çœŸæ­£éƒ¨ç½²çš„æ—¶å€™ï¼Œå¾ˆå°‘ç”¨ã€‚

æ¢å¤
```sh
docker stop test2
docker rm test2
docker run -d --name test2 busybox /bin/sh -c "while true; do sleep 3600; done"
```

åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šnetwork

```sh
docker ps
docker network ls
# è‡ªå·±åˆ›å»ºä¸€ä¸ª bridge
docker network create
# -dï¼šæŒ‡å®š driver
docker network create -d bridge my-bridge
# çœ‹åˆ°äº†my-bridge
docker network ls 

brctl show # ä¹Ÿèƒ½çœ‹åˆ°
# --network è¿æ¥åˆ° my-bridge
docker run -d --name test3 --network my-bridge busybox /bin/sh -c "while true; do sleep 3600; done"
# çœ‹åˆ°my-bridge æœ‰æ¥å£äº†
brctl show 
# Containerséƒ¨åˆ†ä¹Ÿèƒ½çœ‹å¾—åˆ°
docker network inspect my-bridge

# å¯¹äºå·²ç»å­˜åœ¨çš„å®¹å™¨ï¼Œä¹Ÿå¯ä»¥è¿æ¥åˆ° my-bridge
docker network connect my-bridge test2
docker network inspect my-bridge # æœ‰ test2 å®¹å™¨
docker network inspect bridge # æœ‰ test2 å®¹å™¨

# test2 è¿åˆ°äº†ä¸¤ä¸ª bridge ä¸Šé¢äº†

docker exec -it test3 /bin/sh # è¿›å…¥ test3 å®¹å™¨
ping 172.18.0.3 # test2 èƒ½é€š
ping test2 # ä¹Ÿèƒ½é€šï¼Œå¹¶æ²¡æœ‰æŒ‡å®šlink,åŸå› æ˜¯å› ä¸ºtest2å’Œtest3è¿çš„ç½‘ç»œæ˜¯ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„bridge(å®ƒä»¬ç›¸äº’éƒ½å¯ä»¥é€šè¿‡åå­—ping é€š)
exit

docker exec -it test2 /bin/sh 
ping test3 # ä¹Ÿèƒ½é€š
ping test1 # ä¸èƒ½é€šï¼Œå®ƒæ²¡æœ‰è¿æ¥åˆ°my-bridgeä¸Šé¢
exit

docker network connect my-bridge test1 # æŠŠ test1 åŠ è¿›å»
docker exec -it test2 /bin/sh
ping test1 # é€šäº†
```

*è¿™å°±æ˜¯è‡ªå®šä¹‰bridgeä¸docker0çš„åŒºåˆ«ã€‚ä¸ç”¨ linkï¼Œä¹Ÿèƒ½ç›´æ¥ç”¨åå­—äº’é€š*

### å®¹å™¨çš„ç«¯å£æ˜ å°„(å¯¹å¤–æä¾›æœåŠ¡)
```sh
docker run --name web -d -p 80:80 nginx # -p 80:80-->>å®¹å™¨é‡Œé¢çš„80æ˜ å°„åˆ°æœ¬åœ°çš„80
curl 127.0.0.1 # æœ‰æ•°æ®ï¼Œç»‘å®šæˆåŠŸ
```
Mac æ‰“å¼€ http://192.168.205.10/ --> æœ‰æ•°æ®

*Aliyun å®æ“ä¸€ä¸‹*

æˆ‘çš„æœ¬åœ° Mac 
```sh
docker-machine create -d aliyunecs --aliyunecs-io-optimized=optimized --aliyunecs-access-key-id=<your key> --aliyunecs-access-key-secret=<your secret> --aliyunecs-region=cn-qingdao devops

docker-machine ls
NAME     ACTIVE   DRIVER      STATE     URL                         SWARM   DOCKER     ERRORS
devops   -        aliyunecs   Running   tcp://xx.xx.xx.xx:2376           v18.09.1

docker-machine env devops
eval $(docker-machine env devops)

docker version # ç°åœ¨è¿ä¸Šçš„æ˜¯aliyunçš„ä¸»æœº
#docker login # æ³¨æ„è¿™é‡Œé…ç½®ä¸€ä¸‹Aliyun é•œåƒåŠ é€Ÿå™¨ï¼Œä¸ç„¶unauthorized: incorrect username or password.

docker run --name web -d -p 80:80 nginx # æä¾›ä¸€ä¸ªæœåŠ¡
x.x.x.x # å®Œç¾å¯ä»¥è®¿é—®äº‘
docker-machine stop devops
docker-machine rm devops # é¿å…æ‰£é’±
```
é…ç½® [Aliyun é•œåƒåŠ é€Ÿå™¨](https://cr.console.aliyun.com/cn-qingdao/mirrors)
```sh
docker-machine ssh devops
```

### å®¹å™¨ç½‘ç»œä¹‹hostå’Œnone

*none network*

```sh
docker run -d --name test1 --network none busybox /bin/sh -c "while true; do sleep 3600; done"

docker network inspect none # æ³¨æ„Containerséƒ¨åˆ†
# å‘ç°ipåœ°å€ï¼Œmacåœ°å€éƒ½æ²¡æœ‰
docker exec -it test1 /bin/sh # è¿›å»

ip a
#1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1000
#    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
#    inet 127.0.0.1/8 scope host lo
#       valid_lft forever preferred_lft forever

# åªæœ‰æœ¬åœ°çš„ä¸€ä¸ªå›ç¯å£ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­¤ç«‹network namespace

exit

docker stop test1
docker rm test1
```

*host network*

```sh
docker run -d --name test1 --network host busybox /bin/sh -c "while true; do sleep 3600; done"

docker network inspect host # æ³¨æ„Containerséƒ¨åˆ†
# å‘ç°ipåœ°å€ï¼Œmacåœ°å€éƒ½æ²¡æœ‰
docker exec -it test1 /bin/sh # è¿›å»

ip a # å‘ç°çœ‹åˆ°çš„æ¥å£å’Œå¤–é¢å®¿ä¸»æœºæ˜¯å…±äº«çš„ï¼Œæ²¡æœ‰è‡ªå·±çš„network namespace
# ä¼šå­˜åœ¨ç«¯å£å†²çªçš„é—®é¢˜
```

### å¤šå®¹å™¨å¤æ‚åº”ç”¨çš„éƒ¨ç½²

```sh
# [vagrant@docker-node1 flask-redis]$ pwd
# /home/vagrant/labs/flask-redis
# å®æ“
docker run -d --name redis redis 
# éƒ¨ç½²ä¸€ä¸ªrediså®¹å™¨, æ²¡æœ‰åŠ  -p 6379:6379ï¼Œä¸ºäº†å®‰å…¨
# å®ƒä¸æ˜¯ç»™å¤–é¢äººè®¿é—®çš„ï¼Œåªæ˜¯ç»™ app å†…éƒ¨è®¿é—®æ¥ç€
# è¦è§£å†³ redis:6379 å¯è®¿é—®

docker ps
docker build -t kirkwwang/flask-redis . # æ„å»ºåº”ç”¨ image
docker images # ç„ä¸€çœ¼é•œåƒ

docker run -d --link redis --name flask-redis -e REDIS_HOST=redis kirkwwang/flask-redis
docker exec -it flask-redis /bin/sh # è¿›å…¥å®¹å™¨
env
#çœ‹åˆ°äº† REDIS_HOST=redis

ping redis # ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„
curl 127.0.0.1:5000 # æ²¡æœ‰é—®é¢˜
curl 127.0.0.1:5000 # æ²¡æœ‰é—®é¢˜
exit

# flask-redis ç«¯å£æ²¡æš´éœ²ï¼Œé‡æ–°å¼„ä¸€ä¸‹
docker stop flask-redis
docker rm flask-redis
docker run -d -p 5000:5000 --link redis --name flask-redis -e REDIS_HOST=redis kirkwwang/flask-redis

# [vagrant@docker-node1 flask-redis]$ curl 127.0.0.1:5000
# Hello Container World! I have been seen 3 times and my hostname is b267774005fa.
# [vagrant@docker-node1 flask-redis]$ curl 127.0.0.1:5000
# Hello Container World! I have been seen 4 times and my hostname is b267774005fa.
# æ²¡æœ‰é—®é¢˜
# å¯åŠ¨å®¹å™¨æ—¶å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ -e è¿™ä¸ªå‚æ•°
# ç¨‹åºä¼šå»å¯¹ç¯å¢ƒå˜é‡ï¼Œä¼ é€’é…ç½®çš„ä¸€ç§æ–¹å¼
```

### overlayå’Œunderlayçš„é€šä¿—è§£é‡Š

å¤šæœºå®¹å™¨é—´é€šä¿¡

[VXLAN](https://www.evoila.de/de/blog/2015/11/06/what-is-vxlan-and-how-it-works/)

[docker overlay-networks](https://www.jianshu.com/p/83d1671e2acc)

![docker overlay-networks](https://upload-images.jianshu.io/upload_images/6000429-326256e845285034.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/720/format/webp)

192.168.205.10  -> 192.168.205.11   
```sh
vagrant ssh docker-node1
ip a
exit
vagrant ssh docker-node2
ip a

# ä¸¤å°ä¸»æœºä¹‹é—´æ˜¯å¯ä»¥é€šä¿¡çš„(underlay)
```

### Docker Overlayç½‘ç»œå’Œetcdå®ç°å¤šæœºå®¹å™¨é€šä¿¡